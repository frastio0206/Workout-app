<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes, viewport-fit=cover">
    <title>üèãÔ∏è –î–Ω–µ–≤–Ω–∏–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ ELITE</title>
    <!-- PWA: –º–∞–Ω–∏—Ñ–µ—Å—Ç –∏ –∏–∫–æ–Ω–∫–∏ -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏">
    <style>
        /* –í—Å–µ —Å—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–∏–∑ –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: linear-gradient(145deg, #0b0f1a 0%, #1a1f2f 100%); 
            min-height: 100vh; 
            padding: 12px; 
            padding-bottom: 80px; 
            -webkit-font-smoothing: antialiased; 
        }
        .app { 
            max-width: 800px; 
            margin: 0 auto; 
            background: rgba(255,255,255,0.98); 
            backdrop-filter: blur(20px); 
            border-radius: 32px; 
            padding: 20px; 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); 
        }
        
        /* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª –¥–ª—è —Ç–∞–±–æ–≤ */
        .tabs-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 24px;
            padding-bottom: 4px;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f5f9;
        }
        .tabs-container::-webkit-scrollbar {
            height: 4px;
        }
        .tabs-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        .tabs-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .tabs { 
            display: flex; 
            gap: 8px; 
            background: #f1f5f9; 
            padding: 6px; 
            border-radius: 100px; 
            width: max-content;
            min-width: 100%;
        }
        .tab { 
            flex: 0 0 auto;
            padding: 12px 20px;
            border: none; 
            border-radius: 100px; 
            background: transparent; 
            font-weight: 600; 
            font-size: 15px; 
            color: #64748b; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            white-space: nowrap;
        }
        .tab.active { 
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); 
            color: white; 
            box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.4); 
        }

        .calendar-section { 
            background: white; 
            border-radius: 24px; 
            padding: 20px; 
            margin-bottom: 20px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.02); 
            border: 1px solid rgba(0,0,0,0.05);
        }
        .calendar-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            flex-wrap: wrap; 
            gap: 10px; 
        }
        .month-nav { 
            display: flex; 
            gap: 12px; 
            align-items: center; 
            margin-bottom: 15px; 
        }
        .month-nav button { 
            background: #f1f5f9; 
            border: none; 
            border-radius: 30px; 
            padding: 10px 20px; 
            font-weight: 600; 
            color: #475569; 
            cursor: pointer; 
            transition: all 0.2s;
        }
        .month-nav button:hover { background: #e2e8f0; }
        
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 6px; 
        }
        .weekday { 
            text-align: center; 
            font-weight: 600; 
            color: #64748b; 
            font-size: 14px; 
            padding: 8px 0; 
        }
        .calendar-day { 
            aspect-ratio: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            background: #f8fafc; 
            border-radius: 16px; 
            cursor: pointer; 
            transition: all 0.2s; 
            font-size: 14px; 
            font-weight: 500; 
            border: 2px solid transparent;
        }
        .calendar-day.trained { 
            background: linear-gradient(145deg, #6366f110, #8b5cf610); 
            border-color: #6366f1; 
            color: #1e293b;
        }
        .calendar-day.selected { 
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); 
            color: white; 
            transform: scale(1.02);
        }

        /* –ì—Ä—É–ø–ø—ã –º—ã—à—Ü (–≤–∫–ª—é—á–∞—è –∫–∞—Ä–¥–∏–æ) */
        .muscle-groups { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
            gap: 10px; 
            margin: 20px 0; 
        }
        .muscle-btn { 
            padding: 12px 8px; 
            border: 2px solid #e2e8f0; 
            border-radius: 20px; 
            background: white; 
            font-weight: 600; 
            font-size: 14px; 
            color: #475569; 
            cursor: pointer; 
            transition: all 0.2s; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 6px; 
        }
        .muscle-btn.active { 
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); 
            color: white; 
            border-color: transparent; 
            transform: translateY(-2px);
            box-shadow: 0 8px 16px -4px rgba(99, 102, 241, 0.3);
        }
        .muscle-icon { font-size: 24px; }

        /* –ö–Ω–æ–ø–∫–∏-–ø–æ–¥—Å–∫–∞–∑–∫–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π */
        .exercise-suggestions-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }
        .suggestion-btn {
            background: #f1f5f9;
            border: none;
            border-radius: 30px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: 0.2s;
            color: #1e293b;
        }
        .suggestion-btn:hover {
            background: #e2e8f0;
        }

        .exercise-card { 
            margin-bottom: 16px; 
            border: 1px solid #e2e8f0; 
            border-radius: 24px; 
            overflow: hidden; 
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.02);
            transition: all 0.3s;
        }
        .exercise-card:hover { box-shadow: 0 8px 20px rgba(0,0,0,0.05); }
        
        .exercise-header { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 16px 20px; 
            background: #f8fafc; 
            cursor: pointer;
            transition: background 0.2s;
        }
        .exercise-header:hover { background: #f1f5f9; }
        
        .exercise-title { 
            font-weight: 600; 
            font-size: 16px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            flex-wrap: wrap; 
        }
        .muscle-badge { 
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); 
            color: white; 
            padding: 4px 12px; 
            border-radius: 30px; 
            font-size: 12px; 
            font-weight: 500;
        }
        .exercise-summary { 
            font-size: 13px; 
            color: #64748b; 
            margin-left: 4px; 
            font-weight: normal; 
        }
        
        .sets-container { 
            padding: 20px; 
            background: white; 
            border-top: 1px solid #e2e8f0;
        }
        .set-item { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            padding: 12px 16px; 
            background: #f8fafc; 
            border-radius: 20px; 
            margin-bottom: 8px; 
            flex-wrap: wrap; 
            transition: all 0.2s;
        }
        .set-item:hover { background: #f1f5f9; }
        
        .set-inputs { 
            display: flex; 
            gap: 16px; 
            flex: 1; 
            flex-wrap: wrap; 
        }
        .set-input { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            background: white;
            padding: 6px 16px;
            border-radius: 40px;
            border: 1px solid #e2e8f0;
        }
        .set-input input { 
            width: 90px;
            padding: 8px 0;
            border: none; 
            background: transparent; 
            font-size: 15px;
            text-align: center;
        }
        .set-input input:focus { outline: none; }
        .set-input span { 
            color: #64748b;
            font-weight: 500;
            font-size: 14px;
        }

        /* –¢–∞–π–º–µ—Ä */
        .timer-section { 
            background: linear-gradient(145deg, #1e293b, #0f172a); 
            color: white; 
            padding: 24px; 
            border-radius: 28px; 
            margin: 20px 0; 
            box-shadow: 0 20px 30px -10px rgba(0,0,0,0.3);
        }
        .timer-display { 
            font-size: 72px; 
            font-weight: 700; 
            text-align: center; 
            font-family: 'Courier New', monospace; 
            margin: 15px 0; 
            letter-spacing: 5px;
            text-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
        }
        .timer-controls { 
            display: flex; 
            gap: 10px; 
            justify-content: center; 
            flex-wrap: wrap; 
            margin-top: 20px;
        }
        .timer-btn { 
            padding: 14px 24px; 
            border: none; 
            border-radius: 40px; 
            font-weight: 600; 
            cursor: pointer; 
            font-size: 15px;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            min-width: 100px;
        }
        .timer-btn.start { background: #10b981; color: white; }
        .timer-btn.pause { background: #f59e0b; color: white; }
        .timer-btn.resume { background: #10b981; color: white; }
        .timer-btn.stop { background: #ef4444; color: white; }
        .timer-btn:active { transform: scale(0.95); }
        .timer-adjust {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }
        .adjust-btn {
            background: #334155;
            color: white;
            border: none;
            border-radius: 40px;
            padding: 8px 20px;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
            transition: 0.2s;
        }
        .adjust-btn:hover { background: #475569; }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ —Ä–µ–∫–æ—Ä–¥—ã */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 16px; 
            margin-bottom: 24px; 
        }
        .stat-card { 
            background: linear-gradient(145deg, #f8fafc, #f1f5f9); 
            padding: 20px; 
            border-radius: 24px; 
            border: 1px solid rgba(0,0,0,0.02);
            transition: all 0.3s;
        }
        .stat-card:hover { transform: translateY(-4px); }
        .record-item {
            background: white;
            border-radius: 16px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .btn { 
            padding: 16px 28px; 
            border: none; 
            border-radius: 40px; 
            font-weight: 600; 
            cursor: pointer; 
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); 
            color: white;
            transition: all 0.3s;
            box-shadow: 0 8px 16px -4px rgba(99, 102, 241, 0.3);
        }
        .btn:hover { transform: translateY(-2px); }
        .btn.small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .exercise-input { 
            width: 100%; 
            padding: 16px 20px; 
            border: 2px solid #e2e8f0; 
            border-radius: 30px; 
            font-size: 16px; 
            margin-bottom: 12px; 
            transition: all 0.2s;
        }
        .exercise-input:focus { 
            outline: none; 
            border-color: #6366f1; 
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .library-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8fafc;
            border-radius: 20px;
            padding: 12px 20px;
            margin-bottom: 10px;
        }
        .library-info {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .library-actions {
            display: flex;
            gap: 8px;
        }
        .edit-btn, .delete-lib-btn {
            border: none;
            border-radius: 30px;
            padding: 6px 16px;
            font-weight: 600;
            cursor: pointer;
        }
        .edit-btn { background: #3b82f6; color: white; }
        .delete-lib-btn { background: #ef4444; color: white; }

        .hidden { display: none; }
        
        .sync-status { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); 
            color: white; 
            padding: 14px 28px; 
            border-radius: 40px; 
            font-weight: 600; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            z-index: 1000; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            backdrop-filter: blur(10px); 
        }
        
        .timer-active { 
            animation: pulse 1s infinite; 
            color: #fbbf24;
        }
        
        @keyframes pulse { 
            0%,100%{ opacity:1; text-shadow:0 0 30px #fbbf24; } 
            50%{ opacity:0.8; text-shadow:0 0 50px #f59e0b; } 
        }

        .progress-badge { 
            padding: 4px 14px; 
            border-radius: 30px; 
            font-size: 12px; 
            font-weight: 600;
            color: white; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .delete-btn { 
            background: #ef4444; 
            color: white; 
            border: none; 
            border-radius: 30px; 
            padding: 8px 16px; 
            cursor: pointer; 
            font-weight: 600;
            transition: all 0.2s;
        }
        .delete-btn:hover { background: #dc2626; }

        .month-stats {
            margin-top: 16px;
            font-weight: 600;
            color: #1e293b;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab active" data-tab="workout">üí™ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>
                <button class="tab" data-tab="exercises">üèãÔ∏è –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</button>
                <button class="tab" data-tab="calendar">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
                <button class="tab" data-tab="stats">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                <button class="tab" data-tab="analytics">üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ -->
        <div id="workoutTab" class="tab-content">
            <div class="calendar-section">
                <div class="calendar-header">
                    <h3>üìÖ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–Ω—è</h3>
                    <span id="selectedDateDisplay" style="background:#f1f5f9; padding:6px 16px; border-radius:30px;"></span>
                </div>
                <div id="miniCalendar" class="calendar-grid"></div>
            </div>

            <!-- –¢–∞–π–º–µ—Ä -->
            <div class="timer-section">
                <h3 style="display:flex; align-items:center; gap:8px;">‚è±Ô∏è –¢–∞–π–º–µ—Ä –æ—Ç–¥—ã—Ö–∞ <span style="font-size:14px; opacity:0.7;">(–º–µ–∂–¥—É –ø–æ–¥—Ö–æ–¥–∞–º–∏)</span></h3>
                <div class="timer-display" id="timerDisplay">01:00</div>
                <div class="timer-adjust">
                    <button class="adjust-btn" onclick="adjustTimer(-10)">-10 —Å–µ–∫</button>
                    <button class="adjust-btn" onclick="adjustTimer(10)">+10 —Å–µ–∫</button>
                </div>
                <div class="timer-input-group" style="display:flex; gap:10px; justify-content:center; margin:20px 0;">
                    <select id="timerPreset" style="padding:12px 20px; border-radius:40px; border:none; background:#334155; color:white;" onchange="updateTimerFromPreset()">
                        <option value="30">30 —Å–µ–∫</option>
                        <option value="60" selected>1 –º–∏–Ω</option>
                        <option value="120">2 –º–∏–Ω</option>
                        <option value="180">3 –º–∏–Ω</option>
                    </select>
                    <input type="text" id="timerCustomTime" placeholder="–º–º:—Å—Å" value="01:00" style="padding:12px 20px; border-radius:40px; border:none; background:#334155; color:white; width:100px; text-align:center;">
                </div>
                <div class="timer-controls">
                    <button id="timerStartPauseBtn" onclick="toggleTimer()" class="timer-btn start">‚ñ∂ –°—Ç–∞—Ä—Ç</button>
                    <button onclick="stopTimer()" class="timer-btn stop">‚èπ –°—Ç–æ–ø</button>
                    <button onclick="resetTimer()" class="timer-btn" style="background:#64748b;">üîÑ –°–±—Ä–æ—Å</button>
                </div>
            </div>

            <h3 style="display:flex; align-items:center; gap:8px; margin-bottom:16px;">üéØ –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –º—ã—à—Ü</h3>
            <div class="muscle-groups">
                <button class="muscle-btn" onclick="selectMuscleGroup('–†—É–∫–∏')"><span class="muscle-icon">üí™</span>–†—É–∫–∏</button>
                <button class="muscle-btn" onclick="selectMuscleGroup('–°–ø–∏–Ω–∞')"><span class="muscle-icon">üîô</span>–°–ø–∏–Ω–∞</button>
                <button class="muscle-btn" onclick="selectMuscleGroup('–ü–ª–µ—á–∏')"><span class="muscle-icon">üèîÔ∏è</span>–ü–ª–µ—á–∏</button>
                <button class="muscle-btn" onclick="selectMuscleGroup('–ì—Ä—É–¥—å')"><span class="muscle-icon">üèãÔ∏è</span>–ì—Ä—É–¥—å</button>
                <button class="muscle-btn" onclick="selectMuscleGroup('–ù–æ–≥–∏')"><span class="muscle-icon">ü¶µ</span>–ù–æ–≥–∏</button>
                <button class="muscle-btn" onclick="selectMuscleGroup('–ü—Ä–µ—Å—Å')"><span class="muscle-icon">‚ö°</span>–ü—Ä–µ—Å—Å</button>
                <button class="muscle-btn" onclick="selectMuscleGroup('–ö–∞—Ä–¥–∏–æ')"><span class="muscle-icon">‚ù§Ô∏è</span>–ö–∞—Ä–¥–∏–æ</button>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ —Å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã -->
            <div id="exerciseSuggestionsButtons" class="exercise-suggestions-buttons"></div>

            <div style="background:#f8fafc; border-radius:28px; padding:24px; margin:20px 0;">
                <h3 style="margin-bottom:16px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h3>
                <input type="text" id="exerciseNameInput" class="exercise-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ñ–∏–º —à—Ç–∞–Ω–≥–∏ –ª—ë–∂–∞" list="exercise-suggestions" onkeypress="if(event.key==='Enter') addExercise()">
                <datalist id="exercise-suggestions"></datalist>
                <button onclick="addExercise()" class="btn" style="width:100%;">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
            </div>

            <div id="exercisesContainer" class="exercises-grid"></div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π (–±–∏–±–ª–∏–æ—Ç–µ–∫–∞) -->
        <div id="exercisesTab" class="tab-content hidden">
            <h3 style="margin-bottom:20px;">üèãÔ∏è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</h3>
            <div class="muscle-groups" id="libraryMuscleFilter">
                <button class="muscle-btn active" data-muscle="all">–í—Å–µ</button>
                <button class="muscle-btn" data-muscle="–†—É–∫–∏">üí™ –†—É–∫–∏</button>
                <button class="muscle-btn" data-muscle="–°–ø–∏–Ω–∞">üîô –°–ø–∏–Ω–∞</button>
                <button class="muscle-btn" data-muscle="–ü–ª–µ—á–∏">üèîÔ∏è –ü–ª–µ—á–∏</button>
                <button class="muscle-btn" data-muscle="–ì—Ä—É–¥—å">üèãÔ∏è –ì—Ä—É–¥—å</button>
                <button class="muscle-btn" data-muscle="–ù–æ–≥–∏">ü¶µ –ù–æ–≥–∏</button>
                <button class="muscle-btn" data-muscle="–ü—Ä–µ—Å—Å">‚ö° –ü—Ä–µ—Å—Å</button>
                <button class="muscle-btn" data-muscle="–ö–∞—Ä–¥–∏–æ">‚ù§Ô∏è –ö–∞—Ä–¥–∏–æ</button>
            </div>

            <div style="background:#f8fafc; border-radius:28px; padding:24px; margin:20px 0;">
                <h3 style="margin-bottom:16px;">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h3>
                <input type="text" id="newLibExerciseName" class="exercise-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è">
                <div style="display: flex; gap:10px; margin-bottom:16px;">
                    <select id="newLibMuscle" style="flex:1; padding:16px; border:2px solid #e2e8f0; border-radius:30px; font-size:16px;">
                        <option value="–†—É–∫–∏">–†—É–∫–∏</option>
                        <option value="–°–ø–∏–Ω–∞">–°–ø–∏–Ω–∞</option>
                        <option value="–ü–ª–µ—á–∏">–ü–ª–µ—á–∏</option>
                        <option value="–ì—Ä—É–¥—å">–ì—Ä—É–¥—å</option>
                        <option value="–ù–æ–≥–∏">–ù–æ–≥–∏</option>
                        <option value="–ü—Ä–µ—Å—Å">–ü—Ä–µ—Å—Å</option>
                        <option value="–ö–∞—Ä–¥–∏–æ">–ö–∞—Ä–¥–∏–æ</option>
                    </select>
                    <button onclick="addLibraryExercise()" class="btn" style="padding:16px 28px;">‚ûï –°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </div>

            <div id="libraryExercisesList"></div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è -->
        <div id="calendarTab" class="tab-content hidden">
            <div class="calendar-section">
                <div class="calendar-header">
                    <h3>üìÜ –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h3>
                    <div style="display:flex; gap:8px;">
                        <button onclick="exportData()" style="padding:8px 20px; background:#f1f5f9; border:none; border-radius:30px; cursor:pointer;">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
                        <button onclick="importData()" style="padding:8px 20px; background:#f1f5f9; border:none; border-radius:30px; cursor:pointer;">üì• –ò–º–ø–æ—Ä—Ç</button>
                    </div>
                </div>
                <div class="month-nav">
                    <button onclick="changeMonth(-1)">‚Üê –ü—Ä–µ–¥.</button>
                    <span id="currentMonthYear" style="font-weight:600;"></span>
                    <button onclick="changeMonth(1)">–°–ª–µ–¥. ‚Üí</button>
                </div>
                <div id="fullCalendar" class="calendar-grid"></div>
                <div id="monthWorkoutCount" class="month-stats"></div>
                <div id="selectedDayWorkouts" style="margin-top:24px;"></div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
        <div id="statsTab" class="tab-content hidden">
            <h3 style="margin-bottom:20px;">üìä –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –≥—Ä—É–ø–ø–∞–º –º—ã—à—Ü</h3>
            <div id="muscleProgressStats" class="stats-grid"></div>
            
            <h3 style="margin:32px 0 20px;">üèÜ –õ–∏—á–Ω—ã–µ —Ä–µ–∫–æ—Ä–¥—ã</h3>
            <div id="personalBests" class="stats-grid"></div>
            
            <h3 style="margin:32px 0 20px;">üìà –ß–∞—Å—Ç–æ—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h3>
            <div id="workoutFrequency" class="stat-card" style="padding:24px;"></div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ -->
        <div id="analyticsTab" class="tab-content hidden">
            <h3 style="margin-bottom:20px;">üìà –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h3>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div style="font-size:24px;">üìÖ</div>
                    <div><strong>–í—Å–µ–≥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</strong></div>
                    <div style="font-size:28px;" id="totalWorkouts">0</div>
                </div>
                <div class="stat-card">
                    <div style="font-size:24px;">üèãÔ∏è</div>
                    <div><strong>–í—Å–µ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</strong></div>
                    <div style="font-size:28px;" id="totalExercises">0</div>
                </div>
                <div class="stat-card">
                    <div style="font-size:24px;">üîÑ</div>
                    <div><strong>–í—Å–µ–≥–æ –ø–æ–¥—Ö–æ–¥–æ–≤</strong></div>
                    <div style="font-size:28px;" id="totalSets">0</div>
                </div>
            </div>

            <div style="background:#f8fafc; border-radius:24px; padding:20px; margin-top:20px;">
                <h4>üî• –¢–µ–∫—É—â–∞—è —Å–µ—Ä–∏—è</h4>
                <div style="font-size:48px; text-align:center; margin:20px 0;" id="currentStreak">0</div>
                <div style="color:#64748b; text-align:center;">–¥–Ω–µ–π –ø–æ–¥—Ä—è–¥</div>
            </div>
        </div>
    </div>

    <div id="syncStatus" class="sync-status hidden">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</div>

    <script>
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let state = {
            workouts: {},
            selectedDate: new Date().toISOString().split('T')[0],
            selectedMuscle: null,
            currentTab: 'workout',
            calendarMonth: new Date().getMonth(),
            calendarYear: new Date().getFullYear(),
            timer: { 
                active: false, 
                paused: false,
                duration: 60, 
                remaining: 60, 
                interval: null 
            },
            expandedExercises: {},
            exercisesLibrary: [] // –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π: [{ id, name, muscleGroup }]
        };

        const STORAGE_KEY = 'workout_diary_elite';

        // --- –ó–∞–≥—Ä—É–∑–∫–∞/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º silent ---
        function loadFromStorage() {
            showSyncStatus('–ó–∞–≥—Ä—É–∑–∫–∞...');
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const savedState = JSON.parse(saved);
                    if (!savedState.expandedExercises) savedState.expandedExercises = {};
                    if (!savedState.exercisesLibrary) savedState.exercisesLibrary = [];
                    state = { ...state, ...savedState };
                    showSyncStatus('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ');
                }
            } catch (e) {
                console.error(e);
                showSyncStatus('‚ö†Ô∏è –û—à–∏–±–∫–∞');
            }
            setTimeout(hideSyncStatus, 1500);
            renderAll();
        }

        function saveToStorage(silent = false) {
            if (!silent) {
                showSyncStatus('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
            }
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                if (!silent) {
                    showSyncStatus('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
                    setTimeout(hideSyncStatus, 1500);
                }
            } catch (e) {
                if (!silent) {
                    showSyncStatus('‚ö†Ô∏è –û—à–∏–±–∫–∞');
                    setTimeout(hideSyncStatus, 1500);
                }
            }
        }

        let autoSaveTimeout;
        function scheduleSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => saveToStorage(true), 500);
        }

        // --- –ö–∞–ª–µ–Ω–¥–∞—Ä—å ---
        function renderCalendar(calendarElementId, forMonth, forYear) {
            const firstDay = new Date(forYear, forMonth, 1);
            const lastDay = new Date(forYear, forMonth + 1, 0);
            let html = '';
            const weekdays = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
            weekdays.forEach(day => html += `<div class="weekday">${day}</div>`);
            
            let firstDayIndex = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
            for (let i = 0; i < firstDayIndex; i++) html += '<div></div>';
            
            for (let d = 1; d <= lastDay.getDate(); d++) {
                const dateStr = `${forYear}-${String(forMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const hasWorkout = state.workouts[dateStr]?.exercises?.length > 0;
                const isSelected = dateStr === state.selectedDate;
                html += `<div class="calendar-day ${hasWorkout ? 'trained' : ''} ${isSelected ? 'selected' : ''}" onclick="selectDate('${dateStr}')">
                    <span>${d}</span>${hasWorkout ? '<span style="font-size:10px;">üí™</span>' : ''}
                </div>`;
            }
            document.getElementById(calendarElementId).innerHTML = html;
        }

        function renderAllCalendars() {
            renderCalendar('miniCalendar', state.calendarMonth, state.calendarYear);
            renderCalendar('fullCalendar', state.calendarMonth, state.calendarYear);
            const monthYearEl = document.getElementById('currentMonthYear');
            if (monthYearEl) {
                monthYearEl.textContent = new Date(state.calendarYear, state.calendarMonth).toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
            }
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∑–∞ –º–µ—Å—è—Ü
            const count = countWorkoutsInMonth(state.calendarYear, state.calendarMonth);
            const monthCountEl = document.getElementById('monthWorkoutCount');
            if (monthCountEl) monthCountEl.textContent = `–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ: ${count}`;
        }

        function countWorkoutsInMonth(year, month) {
            let count = 0;
            for (let d = 1; d <= 31; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                if (state.workouts[dateStr]?.exercises?.length > 0) count++;
            }
            return count;
        }

        function changeMonth(delta) {
            let newMonth = state.calendarMonth + delta;
            let newYear = state.calendarYear;
            if (newMonth < 0) { newMonth = 11; newYear--; }
            if (newMonth > 11) { newMonth = 0; newYear++; }
            state.calendarMonth = newMonth;
            state.calendarYear = newYear;
            renderAllCalendars();
            if (state.currentTab === 'calendar') renderDayWorkouts();
            saveToStorage(); // —è–≤–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ —Å–º–µ–Ω–µ –º–µ—Å—è—Ü–∞
        }

        function selectDate(date) {
            state.selectedDate = date;
            renderAllCalendars();
            renderExercises();
            updateSelectedDateDisplay();
            if (state.currentTab === 'calendar') renderDayWorkouts();
            saveToStorage(); // —è–≤–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –¥–∞—Ç—ã
        }

        function updateSelectedDateDisplay() {
            const el = document.getElementById('selectedDateDisplay');
            if (el) {
                const d = new Date(state.selectedDate + 'T12:00:00');
                el.textContent = d.toLocaleDateString('ru-RU', { weekday: 'short', day: 'numeric', month: 'short' });
            }
        }

        // --- –ì—Ä—É–ø–ø—ã –º—ã—à—Ü –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π ---
        function selectMuscleGroup(muscle) {
            state.selectedMuscle = muscle;
            document.querySelectorAll('.muscle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.includes(muscle));
            });
            renderExerciseSuggestions(muscle);
        }

        function renderExerciseSuggestions(muscle) {
            const container = document.getElementById('exerciseSuggestionsButtons');
            if (!container) return;
            if (!muscle) {
                container.innerHTML = '';
                return;
            }
            const exercises = state.exercisesLibrary.filter(e => e.muscleGroup === muscle).slice(0, 10);
            if (exercises.length === 0) {
                container.innerHTML = '<p style="color:#94a3b8;">–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ –¥–ª—è —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã</p>';
                return;
            }
            let html = '';
            exercises.forEach(ex => {
                html += `<button class="suggestion-btn" onclick="useSuggestion('${escapeHTML(ex.name)}')">${escapeHTML(ex.name)}</button>`;
            });
            container.innerHTML = html;
        }

        function useSuggestion(name) {
            document.getElementById('exerciseNameInput').value = name;
        }

        // --- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π ---
        function updateExerciseSuggestions() {
            const names = state.exercisesLibrary.map(e => e.name);
            const datalist = document.getElementById('exercise-suggestions');
            datalist.innerHTML = '';
            names.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                datalist.appendChild(opt);
            });
            if (state.selectedMuscle) renderExerciseSuggestions(state.selectedMuscle);
        }

        function ensureExerciseInLibrary(name, muscle) {
            if (!name || !muscle) return;
            const exists = state.exercisesLibrary.some(e => e.name.toLowerCase() === name.toLowerCase() && e.muscleGroup === muscle);
            if (!exists) {
                state.exercisesLibrary.push({
                    id: Date.now() + Math.random(),
                    name: name,
                    muscleGroup: muscle
                });
                scheduleSave(); // –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            }
        }

        function addExercise() {
            const input = document.getElementById('exerciseNameInput');
            const name = input.value.trim();
            if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è');
            if (!state.selectedMuscle) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –º—ã—à—Ü');

            if (!state.workouts[state.selectedDate]) {
                state.workouts[state.selectedDate] = { date: state.selectedDate, exercises: [] };
            }
            
            const exerciseId = Date.now() + Math.random();
            state.workouts[state.selectedDate].exercises.push({
                id: exerciseId,
                name,
                muscleGroup: state.selectedMuscle,
                sets: []
            });
            
            state.expandedExercises[exerciseId] = true;
            
            ensureExerciseInLibrary(name, state.selectedMuscle);
            
            input.value = '';
            updateExerciseSuggestions();
            renderExercises();
            saveToStorage(); // —è–≤–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        }

        // --- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ (–≤–∫–ª–∞–¥–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è) ---
        function renderLibrary(filterMuscle = 'all') {
            const container = document.getElementById('libraryExercisesList');
            if (!container) return;

            let filtered = state.exercisesLibrary;
            if (filterMuscle !== 'all') {
                filtered = filtered.filter(e => e.muscleGroup === filterMuscle);
            }

            if (filtered.length === 0) {
                container.innerHTML = '<p style="color:#94a3b8; text-align:center;">–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</p>';
                return;
            }

            let html = '';
            filtered.sort((a, b) => a.name.localeCompare(b.name));
            filtered.forEach(ex => {
                html += `
                    <div class="library-item" data-id="${ex.id}">
                        <div class="library-info">
                            <strong>${escapeHTML(ex.name)}</strong>
                            <span class="muscle-badge">${ex.muscleGroup}</span>
                        </div>
                        <div class="library-actions">
                            <button class="edit-btn" onclick="editLibraryExercise('${ex.id}')">‚úèÔ∏è –†–µ–¥.</button>
                            <button class="delete-lib-btn" onclick="deleteLibraryExercise('${ex.id}')">üóëÔ∏è –£–¥–∞–ª.</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function addLibraryExercise() {
            const nameInput = document.getElementById('newLibExerciseName');
            const muscleSelect = document.getElementById('newLibMuscle');
            const name = nameInput.value.trim();
            const muscle = muscleSelect.value;
            if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è');
            
            const exists = state.exercisesLibrary.some(e => e.name.toLowerCase() === name.toLowerCase() && e.muscleGroup === muscle);
            if (exists) {
                if (!confirm('–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –í—Å—ë —Ä–∞–≤–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å?')) return;
            }

            state.exercisesLibrary.push({
                id: Date.now() + Math.random(),
                name,
                muscleGroup: muscle
            });
            nameInput.value = '';
            updateExerciseSuggestions();
            renderLibrary(getCurrentLibraryFilter());
            saveToStorage(); // —è–≤–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        }

        function editLibraryExercise(id) {
            const exercise = state.exercisesLibrary.find(e => e.id == id);
            if (!exercise) return;
            const newName = prompt('–ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:', exercise.name);
            if (newName && newName.trim()) {
                exercise.name = newName.trim();
                updateExerciseSuggestions();
                renderLibrary(getCurrentLibraryFilter());
                saveToStorage(); // —è–≤–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            }
        }

        function deleteLibraryExercise(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏? –û–Ω–æ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏—è—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.')) {
                state.exercisesLibrary = state.exercisesLibrary.filter(e => e.id != id);
                updateExerciseSuggestions();
                renderLibrary(getCurrentLibraryFilter());
                saveToStorage(); // —è–≤–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            }
        }

        function getCurrentLibraryFilter() {
            const active = document.querySelector('#libraryMuscleFilter .muscle-btn.active');
            return active ? active.dataset.muscle : 'all';
        }

        // --- –†–µ–Ω–¥–µ—Ä —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ ---
        function toggleExercise(exerciseId) {
            if (state.expandedExercises[exerciseId] === undefined) {
                state.expandedExercises[exerciseId] = true;
            }
            state.expandedExercises[exerciseId] = !state.expandedExercises[exerciseId];
            renderExercises();
            scheduleSave(); // —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ ‚Äì –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –º–æ–∂–Ω–æ –±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        }

        function renderExercises() {
            const container = document.getElementById('exercisesContainer');
            const workout = state.workouts[state.selectedDate];
            if (!workout?.exercises?.length) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#94a3b8;">–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å</div>';
                return;
            }

            let html = '';
            workout.exercises.forEach((ex, idx) => {
                const setsCount = ex.sets.length;
                const isCardio = ex.muscleGroup === '–ö–∞—Ä–¥–∏–æ';
                
                let totalWeight = 0, totalReps = 0, totalMinutes = 0;
                ex.sets.forEach(set => {
                    if (isCardio) {
                        totalMinutes += parseFloat(set.minutes) || 0;
                    } else {
                        totalWeight += parseFloat(set.weight) || 0;
                        totalReps += parseInt(set.reps) || 0;
                    }
                });
                const avgWeight = setsCount && !isCardio ? (totalWeight / setsCount).toFixed(1) : null;
                const summary = isCardio 
                    ? (setsCount ? `${setsCount} –ø–æ–¥—Ö–æ–¥–æ–≤, ${totalMinutes} –º–∏–Ω` : '–Ω–µ—Ç –ø–æ–¥—Ö–æ–¥–æ–≤')
                    : (setsCount ? `${setsCount} –ø–æ–¥—Ö–æ–¥–æ–≤, —Å—É–º–º–∞ ${totalWeight} –∫–≥, —Å—Ä. ${avgWeight} –∫–≥` : '–Ω–µ—Ç –ø–æ–¥—Ö–æ–¥–æ–≤');
                
                const isExpanded = state.expandedExercises[ex.id] !== false;

                html += `
                    <div class="exercise-card" data-exercise-id="${ex.id}">
                        <div class="exercise-header">
                            <div class="exercise-title">
                                <span style="font-size:18px;">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                                <span>${escapeHTML(ex.name)}</span>
                                <span class="muscle-badge">${ex.muscleGroup}</span>
                                <span class="exercise-summary">${summary}</span>
                            </div>
                            <div class="exercise-actions">
                                <button class="delete-btn" data-exercise-index="${idx}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </div>
                        ${isExpanded ? `
                            <div class="sets-container">
                                <button class="add-set-btn" data-exercise-index="${idx}" style="margin-bottom:16px; padding:12px 24px; background:#10b981; color:white; border:none; border-radius:40px; cursor:pointer; font-weight:600;">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥</button>
                                ${renderSets(ex, idx)}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function renderSets(exercise, exerciseIndex) {
            if (!exercise.sets?.length) return '<div style="color:#94a3b8; padding:16px; text-align:center;">–ù–µ—Ç –ø–æ–¥—Ö–æ–¥–æ–≤. –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥"</div>';
            let html = '';
            const isCardio = exercise.muscleGroup === '–ö–∞—Ä–¥–∏–æ';
            exercise.sets.forEach((set, setIndex) => {
                const progress = isCardio 
                    ? analyzeCardioProgress(exercise.muscleGroup, exercise.name, set)
                    : analyzeProgress(exercise.muscleGroup, exercise.name, set);
                html += `
                    <div class="set-item" data-exercise-index="${exerciseIndex}" data-set-index="${setIndex}">
                        <span class="set-number" style="font-weight:700; min-width:40px;">#${setIndex+1}</span>
                        <div class="set-inputs">
                            ${isCardio ? `
                                <div class="set-input">
                                    <span>–ú–∏–Ω—É—Ç—ã</span>
                                    <input type="number" min="0" step="1" value="${set.minutes !== undefined ? set.minutes : ''}" 
                                           class="minutes-input" data-exercise-index="${exerciseIndex}" data-set-index="${setIndex}" placeholder="–º–∏–Ω">
                                </div>
                            ` : `
                                <div class="set-input">
                                    <span>–í–µ—Å</span>
                                    <input type="number" min="0" step="0.5" value="${set.weight !== undefined ? set.weight : ''}" 
                                           class="weight-input" data-exercise-index="${exerciseIndex}" data-set-index="${setIndex}" placeholder="–∫–≥">
                                </div>
                                <div class="set-input">
                                    <span>–ü–æ–≤—Ç</span>
                                    <input type="number" min="1" value="${set.reps !== undefined ? set.reps : ''}" 
                                           class="reps-input" data-exercise-index="${exerciseIndex}" data-set-index="${setIndex}" placeholder="—Ä–∞–∑">
                                </div>
                            `}
                        </div>
                        ${progress ? `<div class="progress-badge" style="background:${progress.color}">${progress.text}</div>` : ''}
                        <button class="delete-set-btn" data-exercise-index="${exerciseIndex}" data-set-index="${setIndex}" style="background:#ef4444; color:white; border:none; border-radius:30px; padding:8px 16px; cursor:pointer;">‚úï</button>
                    </div>
                `;
            });
            return html;
        }

        // –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
        function analyzeProgress(muscle, name, currentSet) {
            if (!currentSet || !currentSet.weight || !currentSet.reps) return null;
            
            let lastSet = null;
            const dates = Object.keys(state.workouts).sort();
            for (const date of dates) {
                if (date >= state.selectedDate) continue;
                const ex = state.workouts[date]?.exercises?.find(e => e.muscleGroup === muscle && e.name === name);
                if (ex?.sets?.length) {
                    for (let i = ex.sets.length - 1; i >= 0; i--) {
                        if (ex.sets[i].weight && ex.sets[i].reps) {
                            lastSet = ex.sets[i];
                            break;
                        }
                    }
                }
            }
            
            if (!lastSet) return null;
            
            const cw = parseFloat(currentSet.weight) || 0;
            const lw = parseFloat(lastSet.weight) || 0;
            const cr = parseInt(currentSet.reps) || 0;
            const lr = parseInt(lastSet.reps) || 0;
            
            if (cw > lw || (cw === lw && cr > lr)) {
                return { text: `üìà +${cw>lw ? (cw-lw).toFixed(1)+'–∫–≥' : (cr-lr)+'–ø–æ–≤—Ç'}`, color: '#10b981' };
            } else if (cw < lw || (cw === lw && cr < lr)) {
                return { text: 'üìâ –°–Ω–∏–∂–µ–Ω–∏–µ', color: '#ef4444' };
            }
            return null;
        }

        // –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –¥–ª—è –∫–∞—Ä–¥–∏–æ (–ø–æ –º–∏–Ω—É—Ç–∞–º)
        function analyzeCardioProgress(muscle, name, currentSet) {
            if (!currentSet || !currentSet.minutes) return null;
            
            let lastSet = null;
            const dates = Object.keys(state.workouts).sort();
            for (const date of dates) {
                if (date >= state.selectedDate) continue;
                const ex = state.workouts[date]?.exercises?.find(e => e.muscleGroup === muscle && e.name === name);
                if (ex?.sets?.length) {
                    for (let i = ex.sets.length - 1; i >= 0; i--) {
                        if (ex.sets[i].minutes) {
                            lastSet = ex.sets[i];
                            break;
                        }
                    }
                }
            }
            
            if (!lastSet) return null;
            
            const cm = parseFloat(currentSet.minutes) || 0;
            const lm = parseFloat(lastSet.minutes) || 0;
            
            if (cm > lm) {
                return { text: `üìà +${(cm - lm).toFixed(0)} –º–∏–Ω`, color: '#10b981' };
            } else if (cm < lm) {
                return { text: 'üìâ –°–Ω–∏–∂–µ–Ω–∏–µ', color: '#ef4444' };
            }
            return null;
        }

        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ç–∞–º–∏ ---
        function addSet(exerciseIndex) {
            const ex = state.workouts[state.selectedDate]?.exercises[exerciseIndex];
            if (ex) {
                if (ex.muscleGroup === '–ö–∞—Ä–¥–∏–æ') {
                    ex.sets.push({ minutes: undefined });
                } else {
                    ex.sets.push({ weight: undefined, reps: undefined });
                }
                state.expandedExercises[ex.id] = true;
                renderExercises();
                saveToStorage(); // —è–≤–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            }
        }

        function updateSet(exIndex, setIndex, field, value) {
            const set = state.workouts[state.selectedDate]?.exercises[exIndex]?.sets[setIndex];
            if (set) {
                set[field] = value === '' ? undefined : value;
                renderExercises();
                scheduleSave(); // –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            }
        }

        function deleteSet(exIndex, setIndex) {
            state.workouts[state.selectedDate]?.exercises[exIndex]?.sets.splice(setIndex, 1);
            renderExercises();
            saveToStorage(); // —è–≤–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        }

        function deleteExercise(exIndex) {
            const workout = state.workouts[state.selectedDate];
            if (workout?.exercises) {
                workout.exercises.splice(exIndex, 1);
                renderExercises();
                saveToStorage(); // —è–≤–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            }
        }

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π ---
        function clickHandler(e) {
            const target = e.target;
            
            const deleteBtn = target.closest('.delete-btn');
            if (deleteBtn && deleteBtn.dataset.exerciseIndex !== undefined) {
                e.preventDefault();
                e.stopPropagation();
                const idx = parseInt(deleteBtn.dataset.exerciseIndex);
                deleteExercise(idx);
                return;
            }
            
            const addSetBtn = target.closest('.add-set-btn');
            if (addSetBtn && addSetBtn.dataset.exerciseIndex !== undefined) {
                e.preventDefault();
                e.stopPropagation();
                const idx = parseInt(addSetBtn.dataset.exerciseIndex);
                addSet(idx);
                return;
            }
            
            const deleteSetBtn = target.closest('.delete-set-btn');
            if (deleteSetBtn && deleteSetBtn.dataset.exerciseIndex !== undefined && deleteSetBtn.dataset.setIndex !== undefined) {
                e.preventDefault();
                e.stopPropagation();
                const exIdx = parseInt(deleteSetBtn.dataset.exerciseIndex);
                const setIdx = parseInt(deleteSetBtn.dataset.setIndex);
                deleteSet(exIdx, setIdx);
                return;
            }
            
            const header = target.closest('.exercise-header');
            if (header) {
                e.preventDefault();
                e.stopPropagation();
                const exerciseCard = header.closest('.exercise-card');
                if (exerciseCard) {
                    const exerciseId = exerciseCard.dataset.exerciseId;
                    if (exerciseId) {
                        toggleExercise(exerciseId);
                    }
                }
                return;
            }
        }

        function changeHandler(e) {
            const target = e.target;
            
            if (target.classList.contains('weight-input') && target.dataset.exerciseIndex !== undefined && target.dataset.setIndex !== undefined) {
                const exIdx = parseInt(target.dataset.exerciseIndex);
                const setIdx = parseInt(target.dataset.setIndex);
                updateSet(exIdx, setIdx, 'weight', target.value);
            }
            
            if (target.classList.contains('reps-input') && target.dataset.exerciseIndex !== undefined && target.dataset.setIndex !== undefined) {
                const exIdx = parseInt(target.dataset.exerciseIndex);
                const setIdx = parseInt(target.dataset.setIndex);
                updateSet(exIdx, setIdx, 'reps', target.value);
            }

            if (target.classList.contains('minutes-input') && target.dataset.exerciseIndex !== undefined && target.dataset.setIndex !== undefined) {
                const exIdx = parseInt(target.dataset.exerciseIndex);
                const setIdx = parseInt(target.dataset.setIndex);
                updateSet(exIdx, setIdx, 'minutes', target.value);
            }
        }

        // --- –¢–∞–π–º–µ—Ä ---
        function updateTimerFromPreset() {
            const preset = document.getElementById('timerPreset').value;
            const minutes = Math.floor(preset / 60);
            const seconds = preset % 60;
            document.getElementById('timerCustomTime').value = `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
            resetTimer();
        }

        function parseTimeInput(input) {
            if (!input) return null;
            input = input.trim();
            if (input.includes(':')) {
                const parts = input.split(':');
                if (parts.length === 2) {
                    const mins = parseInt(parts[0]) || 0;
                    const secs = parseInt(parts[1]) || 0;
                    if (secs < 60) return mins * 60 + secs;
                }
            } else {
                const secs = parseInt(input);
                if (!isNaN(secs) && secs > 0) return secs;
            }
            return null;
        }

        function adjustTimer(delta) {
            let current = parseTimeInput(document.getElementById('timerCustomTime').value);
            if (current === null) current = 60;
            current += delta;
            if (current < 0) current = 0;
            const mins = Math.floor(current / 60);
            const secs = current % 60;
            document.getElementById('timerCustomTime').value = `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
            resetTimer();
        }

        function toggleTimer() {
            if (state.timer.active) {
                if (state.timer.paused) {
                    state.timer.paused = false;
                    state.timer.interval = setInterval(() => {
                        state.timer.remaining--;
                        updateTimerDisplay();
                        if (state.timer.remaining <= 0) timerComplete();
                    }, 1000);
                    document.getElementById('timerStartPauseBtn').textContent = '‚è∏ –ü–∞—É–∑–∞';
                    document.getElementById('timerStartPauseBtn').className = 'timer-btn pause';
                } else {
                    state.timer.paused = true;
                    clearInterval(state.timer.interval);
                    state.timer.interval = null;
                    document.getElementById('timerStartPauseBtn').textContent = '‚ñ∂ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
                    document.getElementById('timerStartPauseBtn').className = 'timer-btn resume';
                }
            } else {
                startTimer();
            }
        }

        function startTimer() {
            if (state.timer.interval) clearInterval(state.timer.interval);
            
            let dur = parseTimeInput(document.getElementById('timerCustomTime').value);
            if (dur === null) dur = parseInt(document.getElementById('timerPreset').value);
            
            state.timer.duration = dur;
            state.timer.remaining = dur;
            state.timer.active = true;
            state.timer.paused = false;
            
            updateTimerDisplay();
            document.getElementById('timerDisplay').classList.add('timer-active');
            
            state.timer.interval = setInterval(() => {
                state.timer.remaining--;
                updateTimerDisplay();
                if (state.timer.remaining <= 0) timerComplete();
            }, 1000);

            document.getElementById('timerStartPauseBtn').textContent = '‚è∏ –ü–∞—É–∑–∞';
            document.getElementById('timerStartPauseBtn').className = 'timer-btn pause';
        }

        function stopTimer() {
            state.timer.active = false;
            state.timer.paused = false;
            if (state.timer.interval) {
                clearInterval(state.timer.interval);
                state.timer.interval = null;
            }
            document.getElementById('timerDisplay').classList.remove('timer-active');
            document.getElementById('timerStartPauseBtn').textContent = '‚ñ∂ –°—Ç–∞—Ä—Ç';
            document.getElementById('timerStartPauseBtn').className = 'timer-btn start';
        }

        function resetTimer() {
            stopTimer();
            let dur = parseTimeInput(document.getElementById('timerCustomTime').value);
            if (dur === null) dur = parseInt(document.getElementById('timerPreset').value);
            state.timer.remaining = dur;
            state.timer.duration = dur;
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const m = Math.floor(state.timer.remaining / 60);
            const s = state.timer.remaining % 60;
            document.getElementById('timerDisplay').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        function timerComplete() {
            stopTimer();
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.frequency.value = 880;
                gain.gain.value = 0.3;
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
                if (audioCtx.state === 'suspended') audioCtx.resume();
            } catch (e) {}
            if (navigator.vibrate) navigator.vibrate([500,200,500]);
            alert('‚è∞ –í—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å!');
        }

        // --- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ —Ä–µ–∫–æ—Ä–¥—ã ---
        function renderMuscleStats() {
            const container = document.getElementById('muscleProgressStats');
            if (!container) return;
            
            const muscles = ['–†—É–∫–∏', '–°–ø–∏–Ω–∞', '–ü–ª–µ—á–∏', '–ì—Ä—É–¥—å', '–ù–æ–≥–∏', '–ü—Ä–µ—Å—Å', '–ö–∞—Ä–¥–∏–æ'];
            let html = '';
            
            muscles.forEach(muscle => {
                const stats = calculateMuscleStats(muscle);
                let displayValue, unit;
                if (muscle === '–ö–∞—Ä–¥–∏–æ') {
                    displayValue = stats.totalMinutes;
                    unit = '–º–∏–Ω';
                } else {
                    displayValue = stats.avgWeight ? stats.avgWeight.toFixed(1) : '0';
                    unit = '–∫–≥';
                }
                
                html += `
                    <div class="stat-card">
                        <div style="font-size:28px;">${getIcon(muscle)}</div>
                        <div><strong>${muscle}</strong></div>
                        <div style="font-size:24px; margin:8px 0;">${displayValue} ${unit}</div>
                        <div style="color:#64748b;">${stats.totalSets} –ø–æ–¥—Ö–æ–¥–æ–≤</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function calculateMuscleStats(muscle) {
            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7*24*3600*1000).toISOString().split('T')[0];
            
            let weeklyWeightSum = 0, monthlyWeightSum = 0;
            let weeklySets = 0, monthlySets = 0;
            let weeklyMinutes = 0, monthlyMinutes = 0;
            
            Object.entries(state.workouts).forEach(([date, workout]) => {
                workout.exercises?.forEach(ex => {
                    if (ex.muscleGroup === muscle) {
                        ex.sets?.forEach(set => {
                            if (muscle === '–ö–∞—Ä–¥–∏–æ') {
                                const minutes = parseFloat(set.minutes) || 0;
                                if (minutes > 0) {
                                    if (date >= weekAgo) weeklyMinutes += minutes;
                                    monthlyMinutes += minutes;
                                    monthlySets++;
                                }
                            } else {
                                const weight = parseFloat(set.weight) || 0;
                                if (weight > 0) {
                                    if (date >= weekAgo) {
                                        weeklyWeightSum += weight;
                                        weeklySets++;
                                    }
                                    monthlyWeightSum += weight;
                                    monthlySets++;
                                }
                            }
                        });
                    }
                });
            });

            const weeklyAvg = weeklySets > 0 ? weeklyWeightSum / weeklySets : 0;
            const monthlyAvg = monthlySets > 0 ? monthlyWeightSum / monthlySets : 0;

            return {
                avgWeight: monthlyAvg,
                totalSets: monthlySets,
                totalMinutes: monthlyMinutes
            };
        }

        function getIcon(muscle) {
            const icons = {
                '–†—É–∫–∏': 'üí™',
                '–°–ø–∏–Ω–∞': 'üîô',
                '–ü–ª–µ—á–∏': 'üèîÔ∏è',
                '–ì—Ä—É–¥—å': 'üèãÔ∏è',
                '–ù–æ–≥–∏': 'ü¶µ',
                '–ü—Ä–µ—Å—Å': '‚ö°',
                '–ö–∞—Ä–¥–∏–æ': '‚ù§Ô∏è'
            };
            return icons[muscle] || 'üí™';
        }

        // –õ–∏—á–Ω—ã–µ —Ä–µ–∫–æ—Ä–¥—ã
        function renderPersonalBests() {
            const container = document.getElementById('personalBests');
            if (!container) return;

            const weightRecords = [];
            const cardioRecords = [];

            Object.values(state.workouts).forEach(workout => {
                workout.exercises?.forEach(ex => {
                    ex.sets?.forEach(set => {
                        if (ex.muscleGroup === '–ö–∞—Ä–¥–∏–æ') {
                            const minutes = parseFloat(set.minutes) || 0;
                            if (minutes > 0) {
                                cardioRecords.push({
                                    name: ex.name,
                                    muscle: ex.muscleGroup,
                                    value: minutes,
                                    unit: '–º–∏–Ω'
                                });
                            }
                        } else {
                            const weight = parseFloat(set.weight) || 0;
                            if (weight > 0) {
                                weightRecords.push({
                                    name: ex.name,
                                    muscle: ex.muscleGroup,
                                    value: weight,
                                    unit: '–∫–≥'
                                });
                            }
                        }
                    });
                });
            });

            const bestWeight = {};
            weightRecords.forEach(r => {
                const key = `${r.muscle}_${r.name}`;
                if (!bestWeight[key] || r.value > bestWeight[key].value) {
                    bestWeight[key] = r;
                }
            });

            const bestCardio = {};
            cardioRecords.forEach(r => {
                const key = `${r.muscle}_${r.name}`;
                if (!bestCardio[key] || r.value > bestCardio[key].value) {
                    bestCardio[key] = r;
                }
            });

            const allBests = [...Object.values(bestWeight), ...Object.values(bestCardio)]
                .sort((a, b) => b.value - a.value)
                .slice(0, 5);

            let html = '';
            if (allBests.length === 0) {
                html = '<p style="color:#94a3b8;">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–æ—Ä–¥–æ–≤</p>';
            } else {
                allBests.forEach(rec => {
                    html += `
                        <div class="record-item">
                            <span><strong>${escapeHTML(rec.name)}</strong> (${rec.muscle})</span>
                            <span style="font-weight:600; color:#6366f1;">${rec.value} ${rec.unit}</span>
                        </div>
                    `;
                });
            }
            container.innerHTML = html;
        }

        // –ß–∞—Å—Ç–æ—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
        function renderWorkoutFrequency() {
            const container = document.getElementById('workoutFrequency');
            if (!container) return;

            const now = new Date();
            const last30Days = new Date(now.getTime() - 30*24*3600*1000).toISOString().split('T')[0];
            let last30Count = 0;
            let totalCount = 0;

            Object.keys(state.workouts).forEach(date => {
                if (state.workouts[date]?.exercises?.length > 0) {
                    totalCount++;
                    if (date >= last30Days) last30Count++;
                }
            });

            container.innerHTML = `
                <div style="font-size:20px; margin-bottom:10px;">üìÖ –ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π: <strong>${last30Count}</strong> —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
                <div style="font-size:20px;">üèãÔ∏è –í—Å–µ–≥–æ: <strong>${totalCount}</strong> —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
            `;
        }

        // --- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ ---
        function renderAnalytics() {
            let totalWorkouts = 0;
            let totalExercises = 0;
            let totalSets = 0;
            
            Object.values(state.workouts).forEach(workout => {
                if (workout.exercises?.length > 0) totalWorkouts++;
                workout.exercises?.forEach(ex => {
                    totalExercises++;
                    totalSets += ex.sets?.length || 0;
                });
            });

            const totalWorkoutsEl = document.getElementById('totalWorkouts');
            const totalExercisesEl = document.getElementById('totalExercises');
            const totalSetsEl = document.getElementById('totalSets');
            const currentStreakEl = document.getElementById('currentStreak');
            
            if (totalWorkoutsEl) totalWorkoutsEl.textContent = totalWorkouts;
            if (totalExercisesEl) totalExercisesEl.textContent = totalExercises;
            if (totalSetsEl) totalSetsEl.textContent = totalSets;

            // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π streak
            let streak = 0;
            let currentDate = new Date();
            currentDate.setHours(0,0,0,0);
            
            const todayStr = currentDate.toISOString().split('T')[0];
            if (state.workouts[todayStr]?.exercises?.length > 0) {
                streak = 1;
                while (true) {
                    currentDate.setDate(currentDate.getDate() - 1);
                    const dateStr = currentDate.toISOString().split('T')[0];
                    if (state.workouts[dateStr]?.exercises?.length > 0) {
                        streak++;
                    } else {
                        break;
                    }
                }
            } else {
                streak = 0;
            }
            
            if (currentStreakEl) currentStreakEl.textContent = streak;
        }

        // --- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ ---
        function switchTab(tabName) {
            state.currentTab = tabName;
            
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.add('hidden');
            });
            
            const selectedTab = document.getElementById(tabName + 'Tab');
            if (selectedTab) {
                selectedTab.classList.remove('hidden');
            }
            
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.getAttribute('data-tab') === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            if (tabName === 'stats') {
                renderMuscleStats();
                renderPersonalBests();
                renderWorkoutFrequency();
            } else if (tabName === 'calendar') { 
                renderAllCalendars(); 
                renderDayWorkouts(); 
            } else if (tabName === 'analytics') {
                renderAnalytics();
            } else if (tabName === 'exercises') {
                renderLibrary('all');
                document.querySelectorAll('#libraryMuscleFilter .muscle-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.muscle === 'all');
                });
            }
        }

        // --- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∑–∞ –¥–µ–Ω—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ ---
        function renderDayWorkouts() {
            const workout = state.workouts[state.selectedDate];
            const container = document.getElementById('selectedDayWorkouts');
            if (!container) return;
            
            if (!workout?.exercises?.length) {
                container.innerHTML = `<h4>${state.selectedDate}</h4><p style="color:#94a3b8;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>`;
                return;
            }
            
            let html = `<h4 style="margin-bottom:16px;">${state.selectedDate}</h4>`;
            workout.exercises.forEach(ex => {
                html += `<div style="background:#f8fafc; border-radius:20px; padding:16px; margin-bottom:12px;">`;
                html += `<div style="display:flex; justify-content:space-between; margin-bottom:10px;">`;
                html += `<strong>${escapeHTML(ex.name)}</strong> <span class="muscle-badge">${ex.muscleGroup}</span>`;
                html += `</div>`;
                ex.sets.forEach((set, i) => {
                    if (ex.muscleGroup === '–ö–∞—Ä–¥–∏–æ') {
                        html += `<div style="display:flex; justify-content:space-between; padding:6px 0;">`;
                        html += `<span>–ü–æ–¥—Ö–æ–¥ ${i+1}:</span>`;
                        html += `<span>${set.minutes || 0} –º–∏–Ω</span>`;
                        html += `</div>`;
                    } else {
                        html += `<div style="display:flex; justify-content:space-between; padding:6px 0;">`;
                        html += `<span>–ü–æ–¥—Ö–æ–¥ ${i+1}:</span>`;
                        html += `<span>${set.weight || 0} –∫–≥ x ${set.reps || 0}</span>`;
                        html += `</div>`;
                    }
                });
                html += `</div>`;
            });
            container.innerHTML = html;
        }

        // --- –≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç ---
        function exportData() {
            const blob = new Blob([JSON.stringify(state, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `workout_backup_${state.selectedDate}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        state = { ...state, ...imported };
                        if (!state.expandedExercises) state.expandedExercises = {};
                        if (!state.exercisesLibrary) state.exercisesLibrary = [];
                        saveToStorage();
                        renderAll();
                        alert('‚úÖ –î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
                    } catch (err) {
                        alert('‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ ---
        function escapeHTML(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showSyncStatus(msg) {
            const el = document.getElementById('syncStatus');
            if (el) {
                el.innerHTML = `üîÑ ${msg}`;
                el.classList.remove('hidden');
            }
        }
        
        function hideSyncStatus() {
            const el = document.getElementById('syncStatus');
            if (el) {
                el.classList.add('hidden');
            }
        }

        function renderAll() {
            renderAllCalendars();
            renderExercises();
            updateSelectedDateDisplay();
            updateExerciseSuggestions();
            renderMuscleStats();
            renderAnalytics();
            if (state.currentTab === 'exercises') {
                renderLibrary('all');
            }
        }

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
        document.addEventListener('DOMContentLoaded', () => {
            loadFromStorage();
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabName = tab.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
            
            const container = document.getElementById('exercisesContainer');
            if (container) {
                container.addEventListener('click', clickHandler);
                container.addEventListener('change', changeHandler);
            }

            // –§–∏–ª—å—Ç—Ä –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
            document.querySelectorAll('#libraryMuscleFilter .muscle-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('#libraryMuscleFilter .muscle-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const muscle = btn.dataset.muscle;
                    renderLibrary(muscle);
                });
            });
            
            switchTab('workout');
            updateTimerDisplay();
        });
    </script>
    <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker registered:', reg))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }
    </script>
</body>
</html>
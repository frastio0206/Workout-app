<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes, viewport-fit=cover">
    <title>üèãÔ∏è –î–Ω–µ–≤–Ω–∏–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ ELITE</title>
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏">
    <!-- Hammer.js –¥–ª—è —Å–≤–∞–π–ø–æ–≤ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: linear-gradient(145deg, #0b0f1a 0%, #1a1f2f 100%); 
            min-height: 100vh; 
            padding: 12px; 
            padding-bottom: 80px; 
            -webkit-font-smoothing: antialiased; 
        }
        .app { 
            max-width: 800px; 
            margin: 0 auto; 
            background: #ffffff; 
            border-radius: 28px; 
            padding: 16px; 
            box-shadow: 0 20px 40px -12px rgba(0,0,0,0.3); 
        }
        
        /* –¢–∞–±—ã —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π */
        .tabs-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 20px;
            padding-bottom: 4px;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f5f9;
        }
        .tabs-container::-webkit-scrollbar {
            height: 4px;
        }
        .tabs-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        .tabs-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .tabs { 
            display: flex; 
            gap: 6px; 
            background: #f1f5f9; 
            padding: 4px; 
            border-radius: 40px; 
            width: max-content;
            min-width: 100%;
        }
        .tab { 
            flex: 0 0 auto;
            padding: 10px 18px;
            border: none; 
            border-radius: 40px; 
            background: transparent; 
            font-weight: 600; 
            font-size: 15px; 
            color: #64748b; 
            cursor: pointer; 
            transition: all 0.2s ease; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 6px; 
            white-space: nowrap;
        }
        .tab:hover {
            background: rgba(255,255,255,0.5);
            transform: scale(1.02);
        }
        .tab.active { 
            background: #ffffff; 
            color: #6366f1; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤–∫–ª–∞–¥–æ–∫ —Å –ø–ª–∞–≤–Ω—ã–º –ø–æ—è–≤–ª–µ–Ω–∏–µ–º */
        .tab-content {
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 1;
            transform: translateX(0);
        }
        .tab-content.hidden {
            display: none;
            /* –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –º—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º display, –Ω–æ –≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ display,
               –ø–æ—ç—Ç–æ–º—É –∞–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ JS.
               –î–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ –º—ã –±—É–¥–µ–º –º–µ–Ω—è—Ç—å –∫–ª–∞—Å—Å—ã —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π */
        }
        /* –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .tab-content:not(.hidden) {
            animation: fadeIn 0.3s ease;
        }

        /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è */
        .calendar-section { 
            background: #f8fafc; 
            border-radius: 20px; 
            padding: 16px; 
            margin-bottom: 16px; 
            transition: box-shadow 0.2s;
        }
        .calendar-section:hover {
            box-shadow: 0 8px 16px rgba(0,0,0,0.05);
        }
        .calendar-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 16px; 
            flex-wrap: wrap; 
            gap: 8px; 
        }
        .calendar-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .calendar-toggle {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #64748b;
            padding: 4px 8px;
            border-radius: 50%;
            transition: background 0.2s, transform 0.2s;
        }
        .calendar-toggle:hover {
            background: #e2e8f0;
            transform: rotate(90deg);
        }
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 4px; 
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, opacity 0.3s;
            opacity: 1;
        }
        .calendar-grid.collapsed {
            max-height: 0;
            opacity: 0;
            margin: 0;
            pointer-events: none;
        }
        .weekday { 
            text-align: center; 
            font-weight: 500; 
            color: #64748b; 
            font-size: 13px; 
            padding: 6px 0; 
        }
        .calendar-day { 
            aspect-ratio: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            background: #ffffff; 
            border-radius: 12px; 
            cursor: pointer; 
            transition: all 0.2s ease; 
            font-size: 14px; 
            font-weight: 500; 
            border: 1px solid #e2e8f0;
        }
        .calendar-day:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .calendar-day.trained { 
            background: #e0e7ff; 
            border-color: #6366f1; 
            color: #1e293b;
        }
        .calendar-day.selected { 
            background: #6366f1; 
            color: white; 
            border-color: #6366f1;
        }
        .month-nav { 
            display: flex; 
            gap: 8px; 
            align-items: center; 
            margin-bottom: 12px; 
        }
        .month-nav button { 
            background: #ffffff; 
            border: none; 
            border-radius: 30px; 
            padding: 8px 16px; 
            font-weight: 600; 
            color: #475569; 
            cursor: pointer; 
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .month-nav button:hover {
            background: #e2e8f0;
            transform: translateY(-2px);
        }

        /* –ì—Ä—É–ø–ø—ã –º—ã—à—Ü */
        .muscle-groups { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); 
            gap: 8px; 
            margin: 16px 0; 
        }
        .muscle-btn { 
            padding: 10px 6px; 
            border: 1px solid #e2e8f0; 
            border-radius: 20px; 
            background: white; 
            font-weight: 600; 
            font-size: 13px; 
            color: #475569; 
            cursor: pointer; 
            transition: all 0.2s ease; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 4px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .muscle-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.08);
            border-color: #6366f1;
        }
        .muscle-btn.active { 
            background: #6366f1; 
            color: white; 
            border-color: transparent; 
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(99,102,241,0.3);
        }

        /* –ö–Ω–æ–ø–∫–∏-–ø–æ–¥—Å–∫–∞–∑–∫–∏ */
        .exercise-suggestions-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 8px 0;
        }
        .suggestion-btn {
            background: #f1f5f9;
            border: none;
            border-radius: 30px;
            padding: 8px 14px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            color: #1e293b;
        }
        .suggestion-btn:hover {
            background: #e2e8f0;
            transform: scale(1.05);
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π —Ä–∞—Å–∫—Ä—ã—Ç–∏—è */
        .exercise-card { 
            margin-bottom: 12px; 
            border: 1px solid #e2e8f0; 
            border-radius: 20px; 
            overflow: hidden; 
            background: white;
            transition: box-shadow 0.3s, transform 0.2s;
            position: relative;
            touch-action: pan-y;
        }
        .exercise-card:hover {
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .exercise-card.dragging {
            opacity: 0.8;
            transform: scale(1.02);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            z-index: 100;
        }
        .exercise-header { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 14px 16px; 
            background: #f8fafc; 
            cursor: pointer;
            transition: background 0.2s;
        }
        .exercise-header:hover {
            background: #e2e8f0;
        }
        .exercise-title { 
            font-weight: 600; 
            font-size: 15px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            flex-wrap: wrap; 
        }
        .muscle-badge { 
            background: #6366f1; 
            color: white; 
            padding: 4px 10px; 
            border-radius: 30px; 
            font-size: 11px; 
            font-weight: 500;
            transition: background 0.2s;
        }
        .exercise-summary { 
            font-size: 12px; 
            color: #64748b; 
            margin-left: 4px; 
            font-weight: normal; 
        }
        
        .sets-container { 
            padding: 16px; 
            background: white; 
            border-top: 1px solid #e2e8f0;
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, opacity 0.3s, padding 0.3s;
            opacity: 1;
        }
        .sets-container.collapsed {
            max-height: 0;
            opacity: 0;
            padding: 0 16px;
        }
        .set-item { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            padding: 10px 12px; 
            background: #f8fafc; 
            border-radius: 16px; 
            margin-bottom: 6px; 
            flex-wrap: wrap; 
            transition: background 0.2s, transform 0.2s;
        }
        .set-item:hover {
            background: #e2e8f0;
            transform: translateX(5px);
        }
        .set-input { 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            background: white;
            padding: 4px 12px;
            border-radius: 30px;
            border: 1px solid #e2e8f0;
            transition: border-color 0.2s;
        }
        .set-input:focus-within {
            border-color: #6366f1;
        }
        .set-input input { 
            width: 70px;
            padding: 6px 0;
            border: none; 
            background: transparent; 
            font-size: 14px;
            text-align: center;
        }
        .set-input input:focus { outline: none; }

        /* –¢–∞–π–º–µ—Ä */
        .timer-section { 
            background: #1e293b; 
            color: white; 
            padding: 20px; 
            border-radius: 24px; 
            margin: 16px 0; 
            box-shadow: 0 15px 25px -8px rgba(0,0,0,0.3);
            transition: box-shadow 0.3s;
        }
        .timer-section:hover {
            box-shadow: 0 20px 30px -8px rgba(0,0,0,0.4);
        }
        .timer-display { 
            font-size: 64px; 
            font-weight: 700; 
            text-align: center; 
            font-family: 'Courier New', monospace; 
            margin: 10px 0; 
            letter-spacing: 4px;
            transition: color 0.2s;
        }
        .timer-input-group { 
            display: flex; 
            gap: 10px; 
            justify-content: center; 
            margin: 15px 0; 
            flex-wrap: wrap; 
        }
        .timer-input-group select, .timer-input-group input { 
            padding: 12px 16px; 
            border-radius: 40px; 
            border: none; 
            background: #334155; 
            color: white; 
            font-size: 16px; 
            transition: background 0.2s, transform 0.2s;
        }
        .timer-input-group select:hover, .timer-input-group input:hover {
            background: #3f4a5f;
            transform: scale(1.02);
        }
        .timer-input-group input { 
            width: 130px; 
            text-align: center;
        }
        .timer-controls { 
            display: flex; 
            gap: 8px; 
            justify-content: center; 
            flex-wrap: wrap; 
        }
        .timer-btn { 
            padding: 12px 20px; 
            border: none; 
            border-radius: 40px; 
            font-weight: 600; 
            cursor: pointer; 
            font-size: 15px;
            transition: all 0.2s;
            min-width: 90px;
        }
        .timer-btn:hover {
            transform: translateY(-3px);
            filter: brightness(1.1);
        }
        .timer-btn.start { background: #10b981; color: white; }
        .timer-btn.pause { background: #f59e0b; color: white; }
        .timer-btn.resume { background: #10b981; color: white; }
        .timer-btn.stop { background: #ef4444; color: white; }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); 
            gap: 12px; 
            margin-bottom: 20px; 
        }
        .stat-card { 
            background: #f8fafc; 
            padding: 16px; 
            border-radius: 20px; 
            transition: all 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn { 
            padding: 14px 24px; 
            border: none; 
            border-radius: 40px; 
            font-weight: 600; 
            cursor: pointer; 
            background: #6366f1; 
            color: white;
            transition: all 0.2s;
            box-shadow: 0 6px 12px rgba(99,102,241,0.2);
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(99,102,241,0.3);
        }

        .exercise-input { 
            width: 100%; 
            padding: 14px 18px; 
            border: 1px solid #e2e8f0; 
            border-radius: 30px; 
            font-size: 16px; 
            margin-bottom: 10px; 
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .exercise-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
            outline: none;
        }

        .library-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8fafc;
            border-radius: 20px;
            padding: 12px 16px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        .library-item:hover {
            background: #e2e8f0;
            transform: translateX(5px);
        }

        .hidden { display: none; }
        
        .sync-status { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            background: #6366f1; 
            color: white; 
            padding: 12px; 
            border-radius: 50%; 
            width: 48px; 
            height: 48px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            box-shadow: 0 8px 16px rgba(0,0,0,0.2); 
            z-index: 1000; 
            font-size: 24px; 
            transition: opacity 0.3s;
        }
        .sync-status.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .timer-active { 
            animation: pulse 1s infinite; 
            color: #fbbf24;
        }
        @keyframes pulse { 
            0%,100%{ opacity:1; } 
            50%{ opacity:0.7; } 
        }

        .progress-badge { 
            padding: 4px 12px; 
            border-radius: 30px; 
            font-size: 11px; 
            font-weight: 600;
            color: white; 
            transition: transform 0.2s;
        }
        .progress-badge:hover {
            transform: scale(1.05);
        }
        .delete-btn { 
            background: #ef4444; 
            color: white; 
            border: none; 
            border-radius: 30px; 
            padding: 6px 12px; 
            cursor: pointer; 
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
        }
        .delete-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }
        .month-stats {
            margin-top: 12px;
            font-weight: 600;
            color: #1e293b;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="app" id="app">
        <div class="tabs-container">
            <div class="tabs" id="tabs">
                <button class="tab active" data-tab="workout">üí™ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>
                <button class="tab" data-tab="exercises">üèãÔ∏è –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</button>
                <button class="tab" data-tab="calendar">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
                <button class="tab" data-tab="stats">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                <button class="tab" data-tab="analytics">üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ -->
        <div id="workoutTab" class="tab-content">
            <div class="calendar-section">
                <div class="calendar-header">
                    <div class="calendar-header-left">
                        <h3>üìÖ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–Ω—è</h3>
                        <button id="toggleCalendarBtn" class="calendar-toggle" onclick="toggleCalendar()">‚ñº</button>
                    </div>
                    <span id="selectedDateDisplay" style="background:#f1f5f9; padding:4px 12px; border-radius:30px; font-size:14px;"></span>
                </div>
                <div id="miniCalendar" class="calendar-grid"></div>
            </div>

            <!-- –¢–∞–π–º–µ—Ä -->
            <div class="timer-section">
                <h3 style="display:flex; align-items:center; gap:6px;">‚è±Ô∏è –û—Ç–¥—ã—Ö</h3>
                <div class="timer-display" id="timerDisplay">01:00</div>
                <div class="timer-input-group">
                    <select id="timerPreset" onchange="updateTimerFromPreset()">
                        <option value="30">30 —Å–µ–∫</option>
                        <option value="60" selected>1 –º–∏–Ω</option>
                        <option value="120">2 –º–∏–Ω</option>
                        <option value="180">3 –º–∏–Ω</option>
                    </select>
                    <input type="text" id="timerCustomTime" placeholder="–º–º:—Å—Å" value="01:00" inputmode="numeric">
                </div>
                <div class="timer-controls">
                    <button id="timerStartPauseBtn" onclick="toggleTimer()" class="timer-btn start">‚ñ∂ –°—Ç–∞—Ä—Ç</button>
                    <button onclick="stopTimer()" class="timer-btn stop">‚èπ –°—Ç–æ–ø</button>
                    <button onclick="resetTimer()" class="timer-btn" style="background:#64748b;">üîÑ –°–±—Ä–æ—Å</button>
                </div>
            </div>

            <h3 style="margin-bottom:10px;">üéØ –ì—Ä—É–ø–ø–∞ –º—ã—à—Ü</h3>
            <div class="muscle-groups">
                <button class="muscle-btn" onclick="selectMuscleGroup('–†—É–∫–∏')"><span class="muscle-icon">üí™</span>–†—É–∫–∏</button>
                <button class="muscle-btn" onclick="selectMuscleGroup('–°–ø–∏–Ω–∞')"><span class="muscle-icon">üîô</span>–°–ø–∏–Ω–∞</button>
                <button class="muscle-btn" onclick="selectMuscleGroup('–ü–ª–µ—á–∏')"><span class="muscle-icon">üèîÔ∏è</span>–ü–ª–µ—á–∏</button>
                <button class="muscle-btn" onclick="selectMuscleGroup('–ì—Ä—É–¥—å')"><span class="muscle-icon">üèãÔ∏è</span>–ì—Ä—É–¥—å</button>
                <button class="muscle-btn" onclick="selectMuscleGroup('–ù–æ–≥–∏')"><span class="muscle-icon">ü¶µ</span>–ù–æ–≥–∏</button>
                <button class="muscle-btn" onclick="selectMuscleGroup('–ü—Ä–µ—Å—Å')"><span class="muscle-icon">‚ö°</span>–ü—Ä–µ—Å—Å</button>
                <button class="muscle-btn" onclick="selectMuscleGroup('–ö–∞—Ä–¥–∏–æ')"><span class="muscle-icon">‚ù§Ô∏è</span>–ö–∞—Ä–¥–∏–æ</button>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
            <div id="exerciseSuggestionsButtons" class="exercise-suggestions-buttons"></div>

            <div style="background:#f8fafc; border-radius:20px; padding:20px; margin:16px 0;">
                <h3 style="margin-bottom:12px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h3>
                <input type="text" id="exerciseNameInput" class="exercise-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" list="exercise-suggestions" onkeypress="if(event.key==='Enter') addExercise()">
                <datalist id="exercise-suggestions"></datalist>
                <button onclick="addExercise()" class="btn" style="width:100%;">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π -->
            <div id="exercisesContainer" class="exercises-grid"></div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π -->
        <div id="exercisesTab" class="tab-content hidden">
            <h3 style="margin-bottom:16px;">üèãÔ∏è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h3>
            <div class="muscle-groups" id="libraryMuscleFilter">
                <button class="muscle-btn active" data-muscle="all">–í—Å–µ</button>
                <button class="muscle-btn" data-muscle="–†—É–∫–∏">üí™ –†—É–∫–∏</button>
                <button class="muscle-btn" data-muscle="–°–ø–∏–Ω–∞">üîô –°–ø–∏–Ω–∞</button>
                <button class="muscle-btn" data-muscle="–ü–ª–µ—á–∏">üèîÔ∏è –ü–ª–µ—á–∏</button>
                <button class="muscle-btn" data-muscle="–ì—Ä—É–¥—å">üèãÔ∏è –ì—Ä—É–¥—å</button>
                <button class="muscle-btn" data-muscle="–ù–æ–≥–∏">ü¶µ –ù–æ–≥–∏</button>
                <button class="muscle-btn" data-muscle="–ü—Ä–µ—Å—Å">‚ö° –ü—Ä–µ—Å—Å</button>
                <button class="muscle-btn" data-muscle="–ö–∞—Ä–¥–∏–æ">‚ù§Ô∏è –ö–∞—Ä–¥–∏–æ</button>
            </div>

            <div style="background:#f8fafc; border-radius:20px; padding:20px; margin:16px 0;">
                <h3 style="margin-bottom:12px;">‚ûï –°–æ–∑–¥–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h3>
                <input type="text" id="newLibExerciseName" class="exercise-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
                <div style="display:flex; gap:8px; margin-bottom:12px;">
                    <select id="newLibMuscle" style="flex:1; padding:12px; border:1px solid #e2e8f0; border-radius:30px;">
                        <option value="–†—É–∫–∏">–†—É–∫–∏</option>
                        <option value="–°–ø–∏–Ω–∞">–°–ø–∏–Ω–∞</option>
                        <option value="–ü–ª–µ—á–∏">–ü–ª–µ—á–∏</option>
                        <option value="–ì—Ä—É–¥—å">–ì—Ä—É–¥—å</option>
                        <option value="–ù–æ–≥–∏">–ù–æ–≥–∏</option>
                        <option value="–ü—Ä–µ—Å—Å">–ü—Ä–µ—Å—Å</option>
                        <option value="–ö–∞—Ä–¥–∏–æ">–ö–∞—Ä–¥–∏–æ</option>
                    </select>
                    <button onclick="addLibraryExercise()" class="btn">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </div>

            <div id="libraryExercisesList"></div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è -->
        <div id="calendarTab" class="tab-content hidden">
            <div class="calendar-section">
                <div class="calendar-header">
                    <h3>üìÜ –ò—Å—Ç–æ—Ä–∏—è</h3>
                    <div style="display:flex; gap:8px;">
                        <button onclick="exportData()" style="padding:6px 16px; background:#f1f5f9; border:none; border-radius:30px;">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
                        <button onclick="importData()" style="padding:6px 16px; background:#f1f5f9; border:none; border-radius:30px;">üì• –ò–º–ø–æ—Ä—Ç</button>
                    </div>
                </div>
                <div class="month-nav">
                    <button onclick="changeMonth(-1)">‚Üê</button>
                    <span id="currentMonthYear" style="font-weight:600;"></span>
                    <button onclick="changeMonth(1)">‚Üí</button>
                </div>
                <div id="fullCalendar" class="calendar-grid"></div>
                <div id="monthWorkoutCount" class="month-stats"></div>
                <div id="selectedDayWorkouts" style="margin-top:16px;"></div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
        <div id="statsTab" class="tab-content hidden">
            <h3 style="margin-bottom:16px;">üìä –ü—Ä–æ–≥—Ä–µ—Å—Å</h3>
            <div id="muscleProgressStats" class="stats-grid"></div>
            <h3 style="margin:24px 0 12px;">üèÜ –õ–∏—á–Ω—ã–µ —Ä–µ–∫–æ—Ä–¥—ã</h3>
            <div id="personalBests" class="stats-grid"></div>
            <h3 style="margin:24px 0 12px;">üìà –ß–∞—Å—Ç–æ—Ç–∞</h3>
            <div id="workoutFrequency" class="stat-card"></div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ -->
        <div id="analyticsTab" class="tab-content hidden">
            <h3 style="margin-bottom:16px;">üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div style="font-size:24px;">üìÖ</div>
                    <div><strong>–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</strong></div>
                    <div style="font-size:28px;" id="totalWorkouts">0</div>
                </div>
                <div class="stat-card">
                    <div style="font-size:24px;">üèãÔ∏è</div>
                    <div><strong>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</strong></div>
                    <div style="font-size:28px;" id="totalExercises">0</div>
                </div>
                <div class="stat-card">
                    <div style="font-size:24px;">üîÑ</div>
                    <div><strong>–ü–æ–¥—Ö–æ–¥–æ–≤</strong></div>
                    <div style="font-size:28px;" id="totalSets">0</div>
                </div>
            </div>
            <div style="background:#f8fafc; border-radius:20px; padding:20px;">
                <h4>üî• –¢–µ–∫—É—â–∞—è —Å–µ—Ä–∏—è</h4>
                <div style="font-size:48px; text-align:center;" id="currentStreak">0</div>
                <div style="color:#64748b; text-align:center;">–¥–Ω–µ–π –ø–æ–¥—Ä—è–¥</div>
            </div>
        </div>
    </div>

    <div id="syncStatus" class="sync-status hidden">üîÑ</div>

    <script>
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let state = {
            workouts: {},
            selectedDate: new Date().toISOString().split('T')[0],
            selectedMuscle: null,
            currentTab: 'workout',
            calendarMonth: new Date().getMonth(),
            calendarYear: new Date().getFullYear(),
            timer: { 
                active: false, 
                paused: false,
                duration: 60, 
                remaining: 60, 
                interval: null 
            },
            expandedExercises: {},
            exercisesLibrary: [],
            calendarCollapsed: false
        };

        const STORAGE_KEY = 'workout_diary_elite';
        let syncTimeout = null;

        function loadFromStorage() {
            showSyncStatus('üîÑ');
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const savedState = JSON.parse(saved);
                    if (!savedState.expandedExercises) savedState.expandedExercises = {};
                    if (!savedState.exercisesLibrary) savedState.exercisesLibrary = [];
                    if (savedState.calendarCollapsed === undefined) savedState.calendarCollapsed = false;
                    state = { ...state, ...savedState };
                }
            } catch (e) {
                console.error(e);
            }
            setTimeout(hideSyncStatus, 500);
            renderAll();
        }

        function saveToStorage(silent = false) {
            if (!silent) {
                showSyncStatus('üîÑ');
            }
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                if (!silent) {
                    if (syncTimeout) clearTimeout(syncTimeout);
                    syncTimeout = setTimeout(hideSyncStatus, 1500);
                }
            } catch (e) {
                if (!silent) {
                    showSyncStatus('‚ö†Ô∏è');
                    setTimeout(hideSyncStatus, 1500);
                }
            }
        }

        let autoSaveTimeout;
        function scheduleSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => saveToStorage(true), 500);
        }

        function showSyncStatus(icon) {
            const el = document.getElementById('syncStatus');
            if (el) {
                el.innerHTML = icon;
                el.classList.remove('hidden');
            }
        }

        function hideSyncStatus() {
            const el = document.getElementById('syncStatus');
            if (el) el.classList.add('hidden');
        }

        // --- –°–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è ---
        function toggleCalendar() {
            state.calendarCollapsed = !state.calendarCollapsed;
            const grid = document.getElementById('miniCalendar');
            const btn = document.getElementById('toggleCalendarBtn');
            if (state.calendarCollapsed) {
                grid.classList.add('collapsed');
                btn.textContent = '‚ñ∂';
            } else {
                grid.classList.remove('collapsed');
                btn.textContent = '‚ñº';
            }
            saveToStorage();
        }

        // --- –ö–∞–ª–µ–Ω–¥–∞—Ä—å ---
        function renderCalendar(calendarElementId, forMonth, forYear) {
            const firstDay = new Date(forYear, forMonth, 1);
            const lastDay = new Date(forYear, forMonth + 1, 0);
            let html = '';
            const weekdays = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
            weekdays.forEach(day => html += `<div class="weekday">${day}</div>`);
            let firstDayIndex = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
            for (let i = 0; i < firstDayIndex; i++) html += '<div></div>';
            for (let d = 1; d <= lastDay.getDate(); d++) {
                const dateStr = `${forYear}-${String(forMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const hasWorkout = state.workouts[dateStr]?.exercises?.length > 0;
                const isSelected = dateStr === state.selectedDate;
                html += `<div class="calendar-day ${hasWorkout ? 'trained' : ''} ${isSelected ? 'selected' : ''}" onclick="selectDate('${dateStr}')">
                    <span>${d}</span>${hasWorkout ? '<span style="font-size:10px;">üí™</span>' : ''}
                </div>`;
            }
            document.getElementById(calendarElementId).innerHTML = html;
            if (calendarElementId === 'miniCalendar') {
                const grid = document.getElementById('miniCalendar');
                if (state.calendarCollapsed) grid.classList.add('collapsed');
                else grid.classList.remove('collapsed');
                const btn = document.getElementById('toggleCalendarBtn');
                if (btn) btn.textContent = state.calendarCollapsed ? '‚ñ∂' : '‚ñº';
            }
        }

        function renderAllCalendars() {
            renderCalendar('miniCalendar', state.calendarMonth, state.calendarYear);
            renderCalendar('fullCalendar', state.calendarMonth, state.calendarYear);
            const monthYearEl = document.getElementById('currentMonthYear');
            if (monthYearEl) {
                monthYearEl.textContent = new Date(state.calendarYear, state.calendarMonth).toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
            }
            const count = countWorkoutsInMonth(state.calendarYear, state.calendarMonth);
            const monthCountEl = document.getElementById('monthWorkoutCount');
            if (monthCountEl) monthCountEl.textContent = `–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫: ${count}`;
        }

        function countWorkoutsInMonth(year, month) {
            let count = 0;
            for (let d = 1; d <= 31; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                if (state.workouts[dateStr]?.exercises?.length > 0) count++;
            }
            return count;
        }

        function changeMonth(delta) {
            let newMonth = state.calendarMonth + delta;
            let newYear = state.calendarYear;
            if (newMonth < 0) { newMonth = 11; newYear--; }
            if (newMonth > 11) { newMonth = 0; newYear++; }
            state.calendarMonth = newMonth;
            state.calendarYear = newYear;
            renderAllCalendars();
            if (state.currentTab === 'calendar') renderDayWorkouts();
            saveToStorage();
        }

        function selectDate(date) {
            state.selectedDate = date;
            renderAllCalendars();
            renderExercises();
            updateSelectedDateDisplay();
            if (state.currentTab === 'calendar') renderDayWorkouts();
            saveToStorage();
        }

        function updateSelectedDateDisplay() {
            const el = document.getElementById('selectedDateDisplay');
            if (el) {
                const d = new Date(state.selectedDate + 'T12:00:00');
                el.textContent = d.toLocaleDateString('ru-RU', { weekday: 'short', day: 'numeric', month: 'short' });
            }
        }

        // --- –ì—Ä—É–ø–ø—ã –º—ã—à—Ü –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è ---
        function selectMuscleGroup(muscle) {
            state.selectedMuscle = muscle;
            document.querySelectorAll('.muscle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.includes(muscle));
            });
            renderExerciseSuggestions(muscle);
        }

        function renderExerciseSuggestions(muscle) {
            const container = document.getElementById('exerciseSuggestionsButtons');
            if (!container) return;
            if (!muscle) {
                container.innerHTML = '';
                return;
            }
            const exercises = state.exercisesLibrary.filter(e => e.muscleGroup === muscle).slice(0, 10);
            if (exercises.length === 0) {
                container.innerHTML = '<p style="color:#94a3b8;">–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ</p>';
                return;
            }
            let html = '';
            exercises.forEach(ex => {
                html += `<button class="suggestion-btn" onclick="quickAddExercise('${escapeHTML(ex.name)}', '${muscle}')">${escapeHTML(ex.name)}</button>`;
            });
            container.innerHTML = html;
        }

        function quickAddExercise(name, muscle) {
            if (!state.workouts[state.selectedDate]) {
                state.workouts[state.selectedDate] = { date: state.selectedDate, exercises: [] };
            }
            const exerciseId = Date.now() + Math.random();
            state.workouts[state.selectedDate].exercises.push({
                id: exerciseId,
                name,
                muscleGroup: muscle,
                sets: []
            });
            state.expandedExercises[exerciseId] = true;
            ensureExerciseInLibrary(name, muscle);
            renderExercises();
            saveToStorage();
        }

        function ensureExerciseInLibrary(name, muscle) {
            if (!name || !muscle) return;
            const exists = state.exercisesLibrary.some(e => e.name.toLowerCase() === name.toLowerCase() && e.muscleGroup === muscle);
            if (!exists) {
                state.exercisesLibrary.push({
                    id: Date.now() + Math.random(),
                    name: name,
                    muscleGroup: muscle
                });
                scheduleSave();
            }
        }

        function addExercise() {
            const input = document.getElementById('exerciseNameInput');
            const name = input.value.trim();
            if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
            if (!state.selectedMuscle) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –º—ã—à—Ü');

            if (!state.workouts[state.selectedDate]) {
                state.workouts[state.selectedDate] = { date: state.selectedDate, exercises: [] };
            }
            const exerciseId = Date.now() + Math.random();
            state.workouts[state.selectedDate].exercises.push({
                id: exerciseId,
                name,
                muscleGroup: state.selectedMuscle,
                sets: []
            });
            state.expandedExercises[exerciseId] = true;
            ensureExerciseInLibrary(name, state.selectedMuscle);
            input.value = '';
            updateExerciseSuggestions();
            renderExercises();
            saveToStorage();
        }

        function updateExerciseSuggestions() {
            const names = state.exercisesLibrary.map(e => e.name);
            const datalist = document.getElementById('exercise-suggestions');
            datalist.innerHTML = '';
            names.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                datalist.appendChild(opt);
            });
            if (state.selectedMuscle) renderExerciseSuggestions(state.selectedMuscle);
        }

        // --- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ ---
        function renderLibrary(filterMuscle = 'all') {
            const container = document.getElementById('libraryExercisesList');
            if (!container) return;
            let filtered = state.exercisesLibrary;
            if (filterMuscle !== 'all') {
                filtered = filtered.filter(e => e.muscleGroup === filterMuscle);
                const select = document.getElementById('newLibMuscle');
                if (select && filterMuscle !== 'all') select.value = filterMuscle;
            }
            if (filtered.length === 0) {
                container.innerHTML = '<p style="color:#94a3b8; text-align:center;">–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</p>';
                return;
            }
            let html = '';
            filtered.sort((a, b) => a.name.localeCompare(b.name));
            filtered.forEach(ex => {
                html += `
                    <div class="library-item" data-id="${ex.id}">
                        <div class="library-info">
                            <strong>${escapeHTML(ex.name)}</strong>
                            <span class="muscle-badge">${ex.muscleGroup}</span>
                        </div>
                        <div class="library-actions">
                            <button class="edit-btn" onclick="editLibraryExercise('${ex.id}')">‚úèÔ∏è</button>
                            <button class="delete-lib-btn" onclick="deleteLibraryExercise('${ex.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function addLibraryExercise() {
            const nameInput = document.getElementById('newLibExerciseName');
            const muscleSelect = document.getElementById('newLibMuscle');
            const name = nameInput.value.trim();
            const muscle = muscleSelect.value;
            if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
            const exists = state.exercisesLibrary.some(e => e.name.toLowerCase() === name.toLowerCase() && e.muscleGroup === muscle);
            if (exists) {
                if (!confirm('–£–∂–µ –µ—Å—Ç—å. –í—Å—ë —Ä–∞–≤–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å?')) return;
            }
            state.exercisesLibrary.push({
                id: Date.now() + Math.random(),
                name,
                muscleGroup: muscle
            });
            nameInput.value = '';
            updateExerciseSuggestions();
            renderLibrary(getCurrentLibraryFilter());
            saveToStorage();
        }

        function editLibraryExercise(id) {
            const exercise = state.exercisesLibrary.find(e => e.id == id);
            if (!exercise) return;
            const newName = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:', exercise.name);
            if (newName && newName.trim()) {
                exercise.name = newName.trim();
            }
            const newMuscle = prompt('–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞ (–†—É–∫–∏, –°–ø–∏–Ω–∞, –ü–ª–µ—á–∏, –ì—Ä—É–¥—å, –ù–æ–≥–∏, –ü—Ä–µ—Å—Å, –ö–∞—Ä–¥–∏–æ):', exercise.muscleGroup);
            if (newMuscle && ['–†—É–∫–∏','–°–ø–∏–Ω–∞','–ü–ª–µ—á–∏','–ì—Ä—É–¥—å','–ù–æ–≥–∏','–ü—Ä–µ—Å—Å','–ö–∞—Ä–¥–∏–æ'].includes(newMuscle)) {
                exercise.muscleGroup = newMuscle;
            }
            updateExerciseSuggestions();
            renderLibrary(getCurrentLibraryFilter());
            saveToStorage();
        }

        function deleteLibraryExercise(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏?')) {
                state.exercisesLibrary = state.exercisesLibrary.filter(e => e.id != id);
                updateExerciseSuggestions();
                renderLibrary(getCurrentLibraryFilter());
                saveToStorage();
            }
        }

        function getCurrentLibraryFilter() {
            const active = document.querySelector('#libraryMuscleFilter .muscle-btn.active');
            return active ? active.dataset.muscle : 'all';
        }

        // --- –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ ---
        function toggleExercise(exerciseId) {
            if (state.expandedExercises[exerciseId] === undefined) {
                state.expandedExercises[exerciseId] = true;
            }
            state.expandedExercises[exerciseId] = !state.expandedExercises[exerciseId];
            renderExercises();
            scheduleSave();
        }

        function renderExercises() {
            const container = document.getElementById('exercisesContainer');
            const workout = state.workouts[state.selectedDate];
            if (!workout?.exercises?.length) {
                container.innerHTML = '<div style="text-align:center; padding:30px; color:#94a3b8;">–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</div>';
                return;
            }

            let html = '';
            workout.exercises.forEach((ex, idx) => {
                const setsCount = ex.sets.length;
                const isCardio = ex.muscleGroup === '–ö–∞—Ä–¥–∏–æ';
                let totalWeight = 0, totalMinutes = 0;
                ex.sets.forEach(set => {
                    if (isCardio) totalMinutes += parseFloat(set.minutes) || 0;
                    else totalWeight += parseFloat(set.weight) || 0;
                });
                const avgWeight = setsCount && !isCardio ? (totalWeight / setsCount).toFixed(1) : null;
                const summary = isCardio 
                    ? (setsCount ? `${setsCount}√ó, ${totalMinutes} –º–∏–Ω` : '–Ω–µ—Ç')
                    : (setsCount ? `${setsCount}√ó, Œ£ ${totalWeight} –∫–≥, —Å—Ä. ${avgWeight} –∫–≥` : '–Ω–µ—Ç');
                const isExpanded = state.expandedExercises[ex.id] !== false;

                html += `
                    <div class="exercise-card" data-exercise-id="${ex.id}" data-index="${idx}" draggable="true">
                        <div class="exercise-header">
                            <div class="exercise-title">
                                <span>${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                                <span>${escapeHTML(ex.name)}</span>
                                <span class="muscle-badge">${ex.muscleGroup}</span>
                                <span class="exercise-summary">${summary}</span>
                            </div>
                            <div class="exercise-actions">
                                <button class="delete-btn" data-exercise-index="${idx}">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="sets-container ${isExpanded ? '' : 'collapsed'}">
                            <button class="add-set-btn" data-exercise-index="${idx}" style="margin-bottom:12px; padding:8px 16px; background:#10b981; color:white; border:none; border-radius:30px;">+ –ü–æ–¥—Ö–æ–¥</button>
                            ${renderSets(ex, idx)}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
            // Drag & drop
            document.querySelectorAll('.exercise-card').forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragend', handleDragEnd);
                // –°–≤–∞–π–ø –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
                const hammertime = new Hammer(card);
                hammertime.on('swipeleft', (ev) => {
                    const id = card.dataset.exerciseId;
                    const workout = state.workouts[state.selectedDate];
                    const index = workout.exercises.findIndex(e => e.id == id);
                    if (index !== -1) deleteExercise(index);
                });
            });
        }

        let dragSrcIndex = null;
        function handleDragStart(e) {
            const card = e.target.closest('.exercise-card');
            if (!card) return;
            dragSrcIndex = parseInt(card.dataset.index);
            e.dataTransfer.setData('text/plain', dragSrcIndex);
            card.classList.add('dragging');
        }
        function handleDragOver(e) { e.preventDefault(); }
        function handleDrop(e) {
            e.preventDefault();
            const targetCard = e.target.closest('.exercise-card');
            if (!targetCard) return;
            const dragTargetIndex = parseInt(targetCard.dataset.index);
            if (dragSrcIndex === null || dragSrcIndex === dragTargetIndex) return;
            const workout = state.workouts[state.selectedDate];
            const exercises = workout.exercises;
            const [removed] = exercises.splice(dragSrcIndex, 1);
            exercises.splice(dragTargetIndex, 0, removed);
            renderExercises();
            saveToStorage();
            dragSrcIndex = null;
        }
        function handleDragEnd(e) {
            document.querySelectorAll('.exercise-card').forEach(c => c.classList.remove('dragging'));
        }

        function renderSets(exercise, exerciseIndex) {
            if (!exercise.sets?.length) return '<div style="color:#94a3b8; padding:12px; text-align:center;">–ù–µ—Ç –ø–æ–¥—Ö–æ–¥–æ–≤</div>';
            let html = '';
            const isCardio = exercise.muscleGroup === '–ö–∞—Ä–¥–∏–æ';
            exercise.sets.forEach((set, setIndex) => {
                const progress = isCardio 
                    ? analyzeCardioProgress(exercise.muscleGroup, exercise.name, set)
                    : analyzeProgress(exercise.muscleGroup, exercise.name, set);
                html += `
                    <div class="set-item" data-exercise-index="${exerciseIndex}" data-set-index="${setIndex}">
                        <span style="font-weight:700;">#${setIndex+1}</span>
                        <div class="set-inputs">
                            ${isCardio ? `
                                <div class="set-input">
                                    <span>–ú–∏–Ω</span>
                                    <input type="number" min="0" step="1" value="${set.minutes !== undefined ? set.minutes : ''}" 
                                           class="minutes-input" data-exercise-index="${exerciseIndex}" data-set-index="${setIndex}" placeholder="0">
                                </div>
                            ` : `
                                <div class="set-input">
                                    <span>–∫–≥</span>
                                    <input type="number" min="0" step="0.5" value="${set.weight !== undefined ? set.weight : ''}" 
                                           class="weight-input" data-exercise-index="${exerciseIndex}" data-set-index="${setIndex}" placeholder="0">
                                </div>
                                <div class="set-input">
                                    <span>—Ä–∞–∑</span>
                                    <input type="number" min="1" value="${set.reps !== undefined ? set.reps : ''}" 
                                           class="reps-input" data-exercise-index="${exerciseIndex}" data-set-index="${setIndex}" placeholder="0">
                                </div>
                            `}
                        </div>
                        ${progress ? `<div class="progress-badge" style="background:${progress.color}">${progress.text}</div>` : ''}
                        <button class="delete-set-btn" data-exercise-index="${exerciseIndex}" data-set-index="${setIndex}" style="background:#ef4444; color:white; border:none; border-radius:30px; padding:4px 10px;">‚úï</button>
                    </div>
                `;
            });
            return html;
        }

        function analyzeProgress(muscle, name, currentSet) {
            if (!currentSet || !currentSet.weight || !currentSet.reps) return null;
            let lastSet = null;
            const dates = Object.keys(state.workouts).sort();
            for (const date of dates) {
                if (date >= state.selectedDate) continue;
                const ex = state.workouts[date]?.exercises?.find(e => e.muscleGroup === muscle && e.name === name);
                if (ex?.sets?.length) {
                    for (let i = ex.sets.length - 1; i >= 0; i--) {
                        if (ex.sets[i].weight && ex.sets[i].reps) {
                            lastSet = ex.sets[i];
                            break;
                        }
                    }
                }
            }
            if (!lastSet) return null;
            const cw = parseFloat(currentSet.weight) || 0;
            const lw = parseFloat(lastSet.weight) || 0;
            const cr = parseInt(currentSet.reps) || 0;
            const lr = parseInt(lastSet.reps) || 0;
            if (cw > lw || (cw === lw && cr > lr)) {
                return { text: `üìà +${cw>lw ? (cw-lw).toFixed(1)+'–∫–≥' : (cr-lr)+'–ø–æ–≤—Ç'}`, color: '#10b981' };
            } else if (cw < lw || (cw === lw && cr < lr)) {
                return { text: 'üìâ', color: '#ef4444' };
            }
            return null;
        }

        function analyzeCardioProgress(muscle, name, currentSet) {
            if (!currentSet || !currentSet.minutes) return null;
            let lastSet = null;
            const dates = Object.keys(state.workouts).sort();
            for (const date of dates) {
                if (date >= state.selectedDate) continue;
                const ex = state.workouts[date]?.exercises?.find(e => e.muscleGroup === muscle && e.name === name);
                if (ex?.sets?.length) {
                    for (let i = ex.sets.length - 1; i >= 0; i--) {
                        if (ex.sets[i].minutes) {
                            lastSet = ex.sets[i];
                            break;
                        }
                    }
                }
            }
            if (!lastSet) return null;
            const cm = parseFloat(currentSet.minutes) || 0;
            const lm = parseFloat(lastSet.minutes) || 0;
            if (cm > lm) return { text: `üìà +${(cm-lm).toFixed(0)} –º–∏–Ω`, color: '#10b981' };
            if (cm < lm) return { text: 'üìâ', color: '#ef4444' };
            return null;
        }

        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ç–∞–º–∏ ---
        function addSet(exerciseIndex) {
            const ex = state.workouts[state.selectedDate]?.exercises[exerciseIndex];
            if (ex) {
                if (ex.muscleGroup === '–ö–∞—Ä–¥–∏–æ') {
                    ex.sets.push({ minutes: undefined });
                } else {
                    ex.sets.push({ weight: undefined, reps: undefined });
                }
                state.expandedExercises[ex.id] = true;
                renderExercises();
                saveToStorage();
            }
        }

        function updateSet(exIndex, setIndex, field, value) {
            const set = state.workouts[state.selectedDate]?.exercises[exIndex]?.sets[setIndex];
            if (set) {
                set[field] = value === '' ? undefined : value;
                renderExercises();
                scheduleSave();
            }
        }

        function deleteSet(exIndex, setIndex) {
            state.workouts[state.selectedDate]?.exercises[exIndex]?.sets.splice(setIndex, 1);
            renderExercises();
            saveToStorage();
        }

        function deleteExercise(exIndex) {
            const workout = state.workouts[state.selectedDate];
            if (workout?.exercises) {
                workout.exercises.splice(exIndex, 1);
                renderExercises();
                saveToStorage();
            }
        }

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ) ---
        function clickHandler(e) {
            const target = e.target;
            const deleteBtn = target.closest('.delete-btn');
            if (deleteBtn && deleteBtn.dataset.exerciseIndex !== undefined) {
                e.preventDefault();
                e.stopPropagation();
                deleteExercise(parseInt(deleteBtn.dataset.exerciseIndex));
                return;
            }
            const addSetBtn = target.closest('.add-set-btn');
            if (addSetBtn && addSetBtn.dataset.exerciseIndex !== undefined) {
                e.preventDefault();
                e.stopPropagation();
                addSet(parseInt(addSetBtn.dataset.exerciseIndex));
                return;
            }
            const deleteSetBtn = target.closest('.delete-set-btn');
            if (deleteSetBtn && deleteSetBtn.dataset.exerciseIndex !== undefined && deleteSetBtn.dataset.setIndex !== undefined) {
                e.preventDefault();
                e.stopPropagation();
                deleteSet(parseInt(deleteSetBtn.dataset.exerciseIndex), parseInt(deleteSetBtn.dataset.setIndex));
                return;
            }
            const header = target.closest('.exercise-header');
            if (header) {
                e.preventDefault();
                e.stopPropagation();
                const exerciseCard = header.closest('.exercise-card');
                if (exerciseCard) {
                    toggleExercise(exerciseCard.dataset.exerciseId);
                }
                return;
            }
        }

        function changeHandler(e) {
            const target = e.target;
            if (target.classList.contains('weight-input') && target.dataset.exerciseIndex !== undefined && target.dataset.setIndex !== undefined) {
                updateSet(parseInt(target.dataset.exerciseIndex), parseInt(target.dataset.setIndex), 'weight', target.value);
            }
            if (target.classList.contains('reps-input') && target.dataset.exerciseIndex !== undefined && target.dataset.setIndex !== undefined) {
                updateSet(parseInt(target.dataset.exerciseIndex), parseInt(target.dataset.setIndex), 'reps', target.value);
            }
            if (target.classList.contains('minutes-input') && target.dataset.exerciseIndex !== undefined && target.dataset.setIndex !== undefined) {
                updateSet(parseInt(target.dataset.exerciseIndex), parseInt(target.dataset.setIndex), 'minutes', target.value);
            }
        }

        // --- –¢–∞–π–º–µ—Ä ---
        function updateTimerFromPreset() {
            const preset = document.getElementById('timerPreset').value;
            const mins = Math.floor(preset / 60);
            const secs = preset % 60;
            document.getElementById('timerCustomTime').value = `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
            resetTimer();
        }

        function parseTimeInput(input) {
            if (!input) return null;
            const parts = input.split(':');
            if (parts.length === 2) {
                const mins = parseInt(parts[0]) || 0;
                const secs = parseInt(parts[1]) || 0;
                return mins * 60 + secs;
            }
            const secs = parseInt(input);
            if (!isNaN(secs) && secs > 0) return secs;
            return null;
        }

        function startTimer() {
            if (state.timer.interval) clearInterval(state.timer.interval);
            let dur = parseTimeInput(document.getElementById('timerCustomTime').value);
            if (dur === null) dur = parseInt(document.getElementById('timerPreset').value);
            state.timer.duration = dur;
            state.timer.remaining = dur;
            state.timer.active = true;
            state.timer.paused = false;
            updateTimerDisplay();
            document.getElementById('timerDisplay').classList.add('timer-active');
            state.timer.interval = setInterval(() => {
                state.timer.remaining--;
                updateTimerDisplay();
                if (state.timer.remaining <= 0) timerComplete();
            }, 1000);
            document.getElementById('timerStartPauseBtn').textContent = '‚è∏ –ü–∞—É–∑–∞';
            document.getElementById('timerStartPauseBtn').className = 'timer-btn pause';
        }

        function stopTimer() {
            state.timer.active = false;
            state.timer.paused = false;
            if (state.timer.interval) {
                clearInterval(state.timer.interval);
                state.timer.interval = null;
            }
            document.getElementById('timerDisplay').classList.remove('timer-active');
            document.getElementById('timerStartPauseBtn').textContent = '‚ñ∂ –°—Ç–∞—Ä—Ç';
            document.getElementById('timerStartPauseBtn').className = 'timer-btn start';
        }

        function resetTimer() {
            stopTimer();
            let dur = parseTimeInput(document.getElementById('timerCustomTime').value);
            if (dur === null) dur = parseInt(document.getElementById('timerPreset').value);
            state.timer.remaining = dur;
            state.timer.duration = dur;
            updateTimerDisplay();
        }

        function toggleTimer() {
            if (state.timer.active) {
                if (state.timer.paused) {
                    state.timer.paused = false;
                    state.timer.interval = setInterval(() => {
                        state.timer.remaining--;
                        updateTimerDisplay();
                        if (state.timer.remaining <= 0) timerComplete();
                    }, 1000);
                    document.getElementById('timerStartPauseBtn').textContent = '‚è∏ –ü–∞—É–∑–∞';
                    document.getElementById('timerStartPauseBtn').className = 'timer-btn pause';
                } else {
                    state.timer.paused = true;
                    clearInterval(state.timer.interval);
                    state.timer.interval = null;
                    document.getElementById('timerStartPauseBtn').textContent = '‚ñ∂ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
                    document.getElementById('timerStartPauseBtn').className = 'timer-btn resume';
                }
            } else {
                startTimer();
            }
        }

        function updateTimerDisplay() {
            const m = Math.floor(state.timer.remaining / 60);
            const s = state.timer.remaining % 60;
            document.getElementById('timerDisplay').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        function timerComplete() {
            stopTimer();
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.frequency.value = 880;
                gain.gain.value = 0.3;
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
                if (audioCtx.state === 'suspended') audioCtx.resume();
            } catch (e) {}
            if (navigator.vibrate) navigator.vibrate([500,200,500]);
            alert('‚è∞ –û—Ç–¥—ã—Ö –∑–∞–∫–æ–Ω—á–µ–Ω!');
        }

        // --- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ (—Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ) ---
        function renderMuscleStats() {
            const container = document.getElementById('muscleProgressStats');
            if (!container) return;
            const muscles = ['–†—É–∫–∏','–°–ø–∏–Ω–∞','–ü–ª–µ—á–∏','–ì—Ä—É–¥—å','–ù–æ–≥–∏','–ü—Ä–µ—Å—Å','–ö–∞—Ä–¥–∏–æ'];
            let html = '';
            muscles.forEach(muscle => {
                const stats = calculateMuscleStats(muscle);
                let display = muscle === '–ö–∞—Ä–¥–∏–æ' ? stats.totalMinutes + ' –º–∏–Ω' : (stats.avgWeight ? stats.avgWeight.toFixed(1) + ' –∫–≥' : '0');
                html += `<div class="stat-card"><div style="font-size:28px;">${getIcon(muscle)}</div><div><strong>${muscle}</strong></div><div style="font-size:20px;">${display}</div><div>${stats.totalSets} –ø–æ–¥—Ö–æ–¥–æ–≤</div></div>`;
            });
            container.innerHTML = html;
        }

        function calculateMuscleStats(muscle) {
            let totalWeight = 0, totalSets = 0, totalMinutes = 0, countWeight = 0;
            Object.values(state.workouts).forEach(w => w.exercises?.forEach(ex => {
                if (ex.muscleGroup === muscle) {
                    ex.sets?.forEach(set => {
                        if (muscle === '–ö–∞—Ä–¥–∏–æ') {
                            totalMinutes += parseFloat(set.minutes) || 0;
                        } else {
                            totalWeight += parseFloat(set.weight) || 0;
                            countWeight++;
                        }
                        totalSets++;
                    });
                }
            }));
            return { avgWeight: countWeight ? totalWeight / countWeight : 0, totalSets, totalMinutes };
        }

        function getIcon(m) {
            const icons = {'–†—É–∫–∏':'üí™','–°–ø–∏–Ω–∞':'üîô','–ü–ª–µ—á–∏':'üèîÔ∏è','–ì—Ä—É–¥—å':'üèãÔ∏è','–ù–æ–≥–∏':'ü¶µ','–ü—Ä–µ—Å—Å':'‚ö°','–ö–∞—Ä–¥–∏–æ':'‚ù§Ô∏è'};
            return icons[m] || 'üí™';
        }

        function renderPersonalBests() {
            const container = document.getElementById('personalBests');
            if (!container) return;
            let records = [];
            Object.values(state.workouts).forEach(w => w.exercises?.forEach(ex => {
                ex.sets?.forEach(set => {
                    if (ex.muscleGroup === '–ö–∞—Ä–¥–∏–æ') {
                        if (set.minutes) records.push({ name: ex.name, val: set.minutes, unit: '–º–∏–Ω' });
                    } else {
                        if (set.weight) records.push({ name: ex.name, val: set.weight, unit: '–∫–≥' });
                    }
                });
            }));
            records.sort((a,b) => b.val - a.val);
            records = records.slice(0,5);
            let html = records.length ? records.map(r => `<div class="record-item"><span>${escapeHTML(r.name)}</span> <strong>${r.val} ${r.unit}</strong></div>`).join('') : '<p>–ü–æ–∫–∞ –Ω–µ—Ç</p>';
            container.innerHTML = html;
        }

        function renderWorkoutFrequency() {
            const container = document.getElementById('workoutFrequency');
            if (!container) return;
            const total = Object.keys(state.workouts).filter(d => state.workouts[d]?.exercises?.length).length;
            container.innerHTML = `<div>–í—Å–µ–≥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫: ${total}</div>`;
        }

        function renderAnalytics() {
            let totalWorkouts = 0, totalExercises = 0, totalSets = 0;
            Object.values(state.workouts).forEach(w => {
                if (w.exercises?.length) totalWorkouts++;
                w.exercises?.forEach(ex => {
                    totalExercises++;
                    totalSets += ex.sets?.length || 0;
                });
            });
            document.getElementById('totalWorkouts').textContent = totalWorkouts;
            document.getElementById('totalExercises').textContent = totalExercises;
            document.getElementById('totalSets').textContent = totalSets;
            let streak = 0;
            let cur = new Date(); cur.setHours(0,0,0,0);
            if (state.workouts[cur.toISOString().split('T')[0]]?.exercises?.length) {
                streak = 1;
                while (true) {
                    cur.setDate(cur.getDate() - 1);
                    if (state.workouts[cur.toISOString().split('T')[0]]?.exercises?.length) streak++;
                    else break;
                }
            }
            document.getElementById('currentStreak').textContent = streak;
        }

        function renderDayWorkouts() {
            const w = state.workouts[state.selectedDate];
            const c = document.getElementById('selectedDayWorkouts');
            if (!c) return;
            if (!w?.exercises?.length) { c.innerHTML = `<h4>${state.selectedDate}</h4><p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>`; return; }
            let html = `<h4>${state.selectedDate}</h4>`;
            w.exercises.forEach(ex => {
                html += `<div style="background:#f8fafc; border-radius:16px; padding:12px; margin-bottom:8px;"><strong>${escapeHTML(ex.name)}</strong> (${ex.muscleGroup})<br>`;
                ex.sets.forEach((s,i) => {
                    if (ex.muscleGroup === '–ö–∞—Ä–¥–∏–æ') html += `–ü–æ–¥—Ö–æ–¥ ${i+1}: ${s.minutes || 0} –º–∏–Ω<br>`;
                    else html += `–ü–æ–¥—Ö–æ–¥ ${i+1}: ${s.weight || 0} –∫–≥ x ${s.reps || 0}<br>`;
                });
                html += '</div>';
            });
            c.innerHTML = html;
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(state)], {type:'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `backup_${state.selectedDate}.json`;
            a.click();
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        state = { ...state, ...imported };
                        if (!state.expandedExercises) state.expandedExercises = {};
                        if (!state.exercisesLibrary) state.exercisesLibrary = [];
                        if (state.calendarCollapsed === undefined) state.calendarCollapsed = false;
                        saveToStorage();
                        renderAll();
                        alert('–ò–º–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤');
                    } catch (err) { alert('–û—à–∏–±–∫–∞'); }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function escapeHTML(t) {
            const div = document.createElement('div');
            div.textContent = t;
            return div.innerHTML;
        }

        function renderAll() {
            renderAllCalendars();
            renderExercises();
            updateSelectedDateDisplay();
            updateExerciseSuggestions();
            renderMuscleStats();
            renderAnalytics();
            if (state.currentTab === 'exercises') renderLibrary('all');
            // –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–≤—ë—Ä–Ω—É—Ç–æ—Å—Ç–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
            const grid = document.getElementById('miniCalendar');
            const btn = document.getElementById('toggleCalendarBtn');
            if (grid && btn) {
                if (state.calendarCollapsed) grid.classList.add('collapsed');
                else grid.classList.remove('collapsed');
                btn.textContent = state.calendarCollapsed ? '‚ñ∂' : '‚ñº';
            }
        }

        function switchTab(tabName) {
            state.currentTab = tabName;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            document.querySelectorAll('.tab').forEach(tab => tab.classList.toggle('active', tab.dataset.tab === tabName));
            if (tabName === 'stats') {
                renderMuscleStats();
                renderPersonalBests();
                renderWorkoutFrequency();
            } else if (tabName === 'calendar') {
                renderAllCalendars();
                renderDayWorkouts();
            } else if (tabName === 'analytics') {
                renderAnalytics();
            } else if (tabName === 'exercises') {
                renderLibrary('all');
                document.querySelectorAll('#libraryMuscleFilter .muscle-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.muscle === 'all'));
            }
        }

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å–≤–∞–π–ø –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ ---
        document.addEventListener('DOMContentLoaded', () => {
            loadFromStorage();

            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', e => {
                    e.preventDefault();
                    switchTab(tab.dataset.tab);
                });
            });

            // –°–≤–∞–π–ø –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫
            const hammertime = new Hammer(document.getElementById('app'));
            hammertime.on('swipeleft', () => {
                const tabs = ['workout','exercises','calendar','stats','analytics'];
                let currentIdx = tabs.indexOf(state.currentTab);
                if (currentIdx < tabs.length - 1) switchTab(tabs[currentIdx + 1]);
            });
            hammertime.on('swiperight', () => {
                const tabs = ['workout','exercises','calendar','stats','analytics'];
                let currentIdx = tabs.indexOf(state.currentTab);
                if (currentIdx > 0) switchTab(tabs[currentIdx - 1]);
            });

            const container = document.getElementById('exercisesContainer');
            if (container) {
                container.addEventListener('click', clickHandler);
                container.addEventListener('change', changeHandler);
            }

            // –§–∏–ª—å—Ç—Ä –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
            document.querySelectorAll('#libraryMuscleFilter .muscle-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('#libraryMuscleFilter .muscle-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderLibrary(btn.dataset.muscle);
                });
            });

            switchTab('workout');
            updateTimerDisplay();
        });
    </script>
    <!-- Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW error:', err));
            });
        }
    </script>
</body>
</html>
